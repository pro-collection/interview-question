### è¯¥è¯é¢˜æ¶‰åŠçš„ç›¸å…³å†…å®¹

- åŽŸç†ï¼šProxyã€trackã€trigger
- æ–°å¢žå±žæ€§
- éåŽ†åŽæ–°å¢ž
- éåŽ†åŽåˆ é™¤æˆ–è€…æ¸…ç©º
- èŽ·å– keys
- åˆ é™¤å¯¹è±¡å±žæ€§
- åˆ¤æ–­å±žæ€§æ˜¯å¦å­˜åœ¨
- æ€§èƒ½

æŽ¨èé˜…è¯»æ–‡æ¡£ï¼š https://juejin.cn/post/6844904122479542285

### å“åº”å¼ä»“åº“

Vue3 ä¸åŒäºŽ Vue2 ä¹Ÿä½“çŽ°åœ¨æºç ç»“æž„ä¸Šï¼ŒVue3 æŠŠè€¦åˆæ€§æ¯”è¾ƒä½Žçš„åŒ…åˆ†æ•£åœ¨ `packages` ç›®å½•ä¸‹å•ç‹¬å‘å¸ƒæˆ `npm` åŒ…ã€‚ è¿™ä¹Ÿæ˜¯ç›®å‰å¾ˆæµè¡Œçš„ä¸€ç§å¤§åž‹é¡¹ç›®ç®¡ç†æ–¹å¼ `Monorepo`ã€‚

å…¶ä¸­è´Ÿè´£å“åº”å¼éƒ¨åˆ†çš„ä»“åº“å°±æ˜¯ `@vue/reactivity`ï¼Œå®ƒä¸æ¶‰åŠ Vue çš„å…¶ä»–çš„ä»»ä½•éƒ¨åˆ†ï¼Œæ˜¯éžå¸¸éžå¸¸ ã€Œæ­£äº¤ã€ çš„ä¸€ç§å®žçŽ°æ–¹å¼ã€‚

ç”šè‡³å¯ä»¥`è½»æ¾çš„é›†æˆè¿› React` https://juejin.cn/post/6844904095594381325

### åŒºåˆ«

Proxy å’Œ Object.defineProperty çš„ä½¿ç”¨æ–¹æ³•çœ‹ä¼¼å¾ˆç›¸ä¼¼ï¼Œå…¶å®ž Proxy æ˜¯åœ¨ ã€Œæ›´é«˜ç»´åº¦ã€ ä¸ŠåŽ»æ‹¦æˆªå±žæ€§çš„ä¿®æ”¹çš„ï¼Œæ€Žä¹ˆç†è§£å‘¢ï¼Ÿ

Vue2 ä¸­ï¼Œå¯¹äºŽç»™å®šçš„ dataï¼Œå¦‚ `{ count: 1 }`ï¼Œæ˜¯éœ€è¦æ ¹æ®å…·ä½“çš„ key ä¹Ÿå°±æ˜¯ `count`ï¼ŒåŽ»å¯¹ã€Œä¿®æ”¹ data.count ã€ å’Œ ã€Œè¯»å– data.countã€è¿›è¡Œæ‹¦æˆªï¼Œä¹Ÿå°±æ˜¯

```javascript
Object.defineProperty(data, 'count', {
  get() {},
  set() {},
})
```

å¿…é¡»é¢„å…ˆçŸ¥é“è¦æ‹¦æˆªçš„ key æ˜¯ä»€ä¹ˆï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ Vue2 é‡Œå¯¹äºŽå¯¹è±¡ä¸Šçš„æ–°å¢žå±žæ€§æ— èƒ½ä¸ºåŠ›ã€‚

è€Œ Vue3 æ‰€ä½¿ç”¨çš„ Proxyï¼Œåˆ™æ˜¯è¿™æ ·æ‹¦æˆªçš„ï¼š

```javascript
new Proxy(data, {
  get(key) { },
  set(key, value) { },
})

```

å¯ä»¥çœ‹åˆ°ï¼Œæ ¹æœ¬ä¸éœ€è¦å…³å¿ƒå…·ä½“çš„ keyï¼Œå®ƒåŽ»æ‹¦æˆªçš„æ˜¯ ã€Œä¿®æ”¹ data ä¸Šçš„ä»»æ„ keyã€ å’Œ ã€Œè¯»å– data ä¸Šçš„ä»»æ„ keyã€ã€‚

æ‰€ä»¥ï¼Œä¸ç®¡æ˜¯å·²æœ‰çš„ key è¿˜æ˜¯æ–°å¢žçš„ keyï¼Œéƒ½é€ƒä¸è¿‡å®ƒçš„é­”çˆªã€‚

ä½†æ˜¯ Proxy æ›´åŠ å¼ºå¤§çš„åœ°æ–¹è¿˜åœ¨äºŽ Proxy é™¤äº† get å’Œ setï¼Œè¿˜å¯ä»¥æ‹¦æˆªæ›´å¤šçš„æ“ä½œç¬¦ã€‚

### ç®€å•çš„ä¾‹å­ðŸŒ°

å…ˆå†™ä¸€ä¸ª Vue3 å“åº”å¼çš„æœ€å°æ¡ˆä¾‹ï¼Œæœ¬æ–‡çš„ç›¸å…³æ¡ˆä¾‹éƒ½åªä¼šç”¨ `reactive` å’Œ `effect` è¿™ä¸¤ä¸ª apiã€‚å¦‚æžœä½ äº†è§£è¿‡ React ä¸­çš„ `useEffect`ï¼Œç›¸ä¿¡ä½ ä¼šå¯¹è¿™ä¸ªæ¦‚å¿µç§’æ‡‚ï¼ŒVue3 çš„ `effect` ä¸è¿‡å°±æ˜¯åŽ»æŽ‰äº†æ‰‹åŠ¨å£°æ˜Žä¾èµ–çš„ã€Œè¿›åŒ–ç‰ˆã€çš„ `useEffect`ã€‚

React ä¸­æ‰‹åŠ¨å£°æ˜Ž `[data.count]` è¿™ä¸ªä¾èµ–çš„æ­¥éª¤è¢« Vue3 å†…éƒ¨ç›´æŽ¥åšæŽ‰äº†ï¼Œåœ¨ `effect` å‡½æ•°å†…éƒ¨è¯»å–åˆ° `data.count` çš„æ—¶å€™ï¼Œå®ƒå°±å·²ç»è¢«æ”¶é›†ä½œä¸ºä¾èµ–äº†ã€‚

Vue3ï¼š

```kotlin
// å“åº”å¼æ•°æ®
const data = reactive({
  count: 1
})

// è§‚æµ‹å˜åŒ–
effect(() => console.log('count changed', data.count))

// è§¦å‘ console.log('count changed', data.count) é‡æ–°æ‰§è¡Œ
data.count = 2

```

Reactï¼š

```scss
// æ•°æ®
const [data, setData] = useState({
  count: 1
})

// è§‚æµ‹å˜åŒ– éœ€è¦æ‰‹åŠ¨å£°æ˜Žä¾èµ–
useEffect(() => {
  console.log('count changed', data.count)
}, [data.count])

// è§¦å‘ console.log('count changed', data.count) é‡æ–°æ‰§è¡Œ
setData({
  count: 2
})

```

ä¹Ÿå¯ä»¥æŠŠ `effect` ä¸­çš„å›žè°ƒå‡½æ•°è”æƒ³åˆ°è§†å›¾çš„é‡æ–°æ¸²æŸ“ã€ watch çš„å›žè°ƒå‡½æ•°ç­‰ç­‰â€¦â€¦ å®ƒä»¬æ˜¯åŒæ ·åŸºäºŽè¿™å¥—å“åº”å¼æœºåˆ¶çš„ã€‚

è€Œæœ¬æ–‡çš„æ ¸å¿ƒç›®çš„ï¼Œå°±æ˜¯æŽ¢ç©¶è¿™ä¸ªåŸºäºŽ Proxy çš„ reactive apiï¼Œåˆ°åº•èƒ½å¼ºå¤§åˆ°ä»€ä¹ˆç¨‹åº¦ï¼Œèƒ½ç›‘å¬åˆ°ç”¨æˆ·å¯¹äºŽä»€ä¹ˆç¨‹åº¦çš„ä¿®æ”¹ã€‚

### è®²è®²åŽŸç†

å…ˆæœ€å°åŒ–çš„è®²è§£ä¸€ä¸‹å“åº”å¼çš„åŽŸç†ï¼Œå…¶å®žå°±æ˜¯åœ¨ Proxy ç¬¬äºŒä¸ªå‚æ•° `handler` ä¹Ÿå°±æ˜¯é™·é˜±æ“ä½œç¬¦ä¸­ï¼Œæ‹¦æˆªå„ç§å–å€¼ã€èµ‹å€¼æ“ä½œï¼Œä¾æ‰˜ `track` å’Œ `trigger` ä¸¤ä¸ªå‡½æ•°è¿›è¡Œä¾èµ–æ”¶é›†å’Œæ´¾å‘æ›´æ–°ã€‚

`track` ç”¨æ¥åœ¨è¯»å–æ—¶æ”¶é›†ä¾èµ–ã€‚

`trigger` ç”¨æ¥åœ¨æ›´æ–°æ—¶è§¦å‘ä¾èµ–ã€‚

### track

```vbnet
function track(target: object, type: TrackOpTypes, key: unknown) {
  const depsMap = targetMap.get(target);
  // æ”¶é›†ä¾èµ–æ—¶ é€šè¿‡ key å»ºç«‹ä¸€ä¸ª set
  let dep = new Set()
  targetMap.set(ITERATE_KEY, dep)
  // è¿™ä¸ª effect å¯ä»¥å…ˆç†è§£ä¸ºæ›´æ–°å‡½æ•° å­˜æ”¾åœ¨ dep é‡Œ
  dep.add(effect)
}

```

`target` æ˜¯åŽŸå¯¹è±¡ã€‚

`type` æ˜¯æœ¬æ¬¡æ”¶é›†çš„ç±»åž‹ï¼Œä¹Ÿå°±æ˜¯æ”¶é›†ä¾èµ–çš„æ—¶å€™ç”¨æ¥æ ‡è¯†æ˜¯ä»€ä¹ˆç±»åž‹çš„æ“ä½œï¼Œæ¯”å¦‚ä¸Šæ–‡ä¾èµ–ä¸­çš„ç±»åž‹å°±æ˜¯ `get`ï¼Œè¿™ä¸ªåŽç»­ä¼šè¯¦ç»†è®²è§£ã€‚

`key` æ˜¯æŒ‡æœ¬æ¬¡è®¿é—®çš„æ˜¯æ•°æ®ä¸­çš„å“ªä¸ª keyï¼Œæ¯”å¦‚ä¸Šæ–‡ä¾‹å­ä¸­æ”¶é›†ä¾èµ–çš„ key å°±æ˜¯ `count`

é¦–å…ˆå…¨å±€ä¼šå­˜åœ¨ä¸€ä¸ª `targetMap`ï¼Œå®ƒç”¨æ¥å»ºç«‹ `æ•°æ® -> ä¾èµ–` çš„æ˜ å°„ï¼Œå®ƒæ˜¯ä¸€ä¸ª WeakMap æ•°æ®ç»“æž„ã€‚

è€Œ `targetMap` é€šè¿‡æ•°æ® `target`ï¼Œå¯ä»¥èŽ·å–åˆ° `depsMap`ï¼Œå®ƒç”¨æ¥å­˜æ”¾è¿™ä¸ªæ•°æ®å¯¹åº”çš„æ‰€æœ‰å“åº”å¼ä¾èµ–ã€‚

`depsMap` çš„æ¯ä¸€é¡¹åˆ™æ˜¯ä¸€ä¸ª Set æ•°æ®ç»“æž„ï¼Œè€Œè¿™ä¸ª Set å°±å­˜æ”¾ç€å¯¹åº” key çš„æ›´æ–°å‡½æ•°ã€‚

æ˜¯ä¸æ˜¯æœ‰ç‚¹ç»•ï¼Ÿæˆ‘ä»¬ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥ä¸¾ä¾‹å§ã€‚

```ini
const target = { count: 1}
const data = reactive(target)

const effection = effect(() => {
  console.log(data.count)
})

```

å¯¹äºŽè¿™ä¸ªä¾‹å­çš„ä¾èµ–å…³ç³»ï¼Œ

1. å…¨å±€çš„ `targetMap` æ˜¯ï¼š

```js
targetMap: {
  { count: 1 }: dep
}

```

2. dep åˆ™æ˜¯

```js
dep: {
  count: Set { effection }
}

```

è¿™æ ·ä¸€å±‚å±‚çš„ä¸‹åŽ»ï¼Œå°±å¯ä»¥é€šè¿‡ `target` æ‰¾åˆ° `count` å¯¹åº”çš„æ›´æ–°å‡½æ•° `effection` äº†ã€‚

### trigger

è¿™é‡Œæ˜¯æœ€å°åŒ–çš„å®žçŽ°ï¼Œä»…ä»…ä¸ºäº†ä¾¿äºŽç†è§£åŽŸç†ï¼Œå®žé™…ä¸Šè¦å¤æ‚å¾ˆå¤šï¼Œ

å…¶å®ž `type` çš„ä½œç”¨å¾ˆå…³é”®ï¼Œå…ˆè®°ä½ï¼ŒåŽé¢ä¼šè¯¦ç»†è®²ã€‚

```typescript
export function trigger(
  target: object,
  type: TriggerOpTypes,
  key?: unknown,
) {
  // ç®€åŒ–æ¥è¯´ å°±æ˜¯é€šè¿‡ key æ‰¾åˆ°æ‰€æœ‰æ›´æ–°å‡½æ•° ä¾æ¬¡æ‰§è¡Œ
  const dep = targetMap.get(target)
  dep.get(key).forEach(effect => effect())
}
```
