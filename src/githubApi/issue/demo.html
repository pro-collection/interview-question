<div class="markdown-body html"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 class="heading" data-id="heading-0">ä¸€ã€å‰è¨€ - webpackçƒ­æ›´æ–°</h2>
  <blockquote>
    <p><code>Hot Module Replacement</code>ï¼Œç®€ç§°<code>HMR</code>ï¼Œæ— éœ€å®Œå…¨åˆ·æ–°æ•´ä¸ªé¡µé¢çš„åŒæ—¶ï¼Œæ›´æ–°æ¨¡å—ã€‚<code>HMR</code>çš„å¥½å¤„ï¼Œåœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­ä½“ä¼šé¢‡æ·±ï¼š<strong>èŠ‚çœå®è´µçš„å¼€å‘æ—¶é—´ã€æå‡å¼€å‘ä½“éªŒ</strong>ã€‚</p>
  </blockquote>
  <p>åˆ·æ–°æˆ‘ä»¬ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼š</p>
  <ul>
    <li>ä¸€ç§æ˜¯é¡µé¢åˆ·æ–°ï¼Œä¸ä¿ç•™é¡µé¢çŠ¶æ€ï¼Œå°±æ˜¯ç®€å•ç²—æš´ï¼Œç›´æ¥<code>window.location.reload()</code>ã€‚</li>
    <li>å¦ä¸€ç§æ˜¯åŸºäº<code>WDS (Webpack-dev-server)</code>çš„æ¨¡å—çƒ­æ›¿æ¢ï¼Œåªéœ€è¦å±€éƒ¨åˆ·æ–°é¡µé¢ä¸Šå‘ç”Ÿå˜åŒ–çš„æ¨¡å—ï¼ŒåŒæ—¶å¯ä»¥ä¿ç•™å½“å‰çš„é¡µé¢çŠ¶æ€ï¼Œæ¯”å¦‚å¤é€‰æ¡†çš„é€‰ä¸­çŠ¶æ€ã€è¾“å…¥æ¡†çš„è¾“å…¥ç­‰ã€‚</li>
  </ul>
  <p><code>HMR</code>ä½œä¸ºä¸€ä¸ª<code>Webpack</code>å†…ç½®çš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡<code>HotModuleReplacementPlugin</code>æˆ–<code>--hot</code>å¼€å¯ã€‚é‚£ä¹ˆï¼Œ<code>HMR</code>åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çƒ­æ›´æ–°çš„å‘¢ï¼Ÿä¸‹é¢è®©æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹å§ï¼</p>
  <h2 class="heading" data-id="heading-1">äºŒã€webpackçš„ç¼–è¯‘æ„å»ºè¿‡ç¨‹</h2>
  <p>é¡¹ç›®å¯åŠ¨åï¼Œè¿›è¡Œæ„å»ºæ‰“åŒ…ï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºæ„å»ºè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ç”Ÿæˆäº†ä¸€ä¸ª <strong>Hashå€¼</strong>ï¼š<code>a93fd735d02d98633356</code>ã€‚
  </p><figure><img alt="é¦–æ¬¡æ„å»ºæ§åˆ¶å°è¾“å‡ºæ—¥å¿—" src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec043909c70b12~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure>
  ç„¶åï¼Œåœ¨æˆ‘ä»¬æ¯æ¬¡ä¿®æ”¹ä»£ç ä¿å­˜åï¼Œæ§åˆ¶å°éƒ½ä¼šå‡ºç° <code>Compilingâ€¦</code>å­—æ ·ï¼Œè§¦å‘æ–°çš„ç¼–è¯‘ä¸­...å¯ä»¥åœ¨æ§åˆ¶å°ä¸­è§‚å¯Ÿåˆ°ï¼š<p></p>
  <ul>
    <li><strong>æ–°çš„Hashå€¼</strong>ï¼š<code>a61bdd6e82294ed06fa3</code></li>
    <li><strong>æ–°çš„jsonæ–‡ä»¶</strong>ï¼š <code>a93fd735d02d98633356.hot-update.json</code></li>
    <li><strong>æ–°çš„jsæ–‡ä»¶</strong>ï¼š<code>index.a93fd735d02d98633356.hot-update.js</code></li>
  </ul>
  <p></p><figure><img alt="ä¿®æ”¹ä»£ç çš„ç¼–è¯‘æ—¥å¿—" src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec04454e1167f7~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p>é¦–å…ˆï¼Œæˆ‘ä»¬çŸ¥é“<code>Hash</code>å€¼ä»£è¡¨æ¯ä¸€æ¬¡ç¼–è¯‘çš„æ ‡è¯†ã€‚å…¶æ¬¡ï¼Œæ ¹æ®æ–°ç”Ÿæˆæ–‡ä»¶åå¯ä»¥å‘ç°ï¼Œä¸Šæ¬¡è¾“å‡ºçš„<code>Hash</code>å€¼ä¼šä½œä¸ºæœ¬æ¬¡ç¼–è¯‘æ–°ç”Ÿæˆçš„æ–‡ä»¶æ ‡è¯†ã€‚ä¾æ¬¡ç±»æ¨ï¼Œæœ¬æ¬¡è¾“å‡ºçš„<code>Hash</code>å€¼ä¼šè¢«ä½œä¸ºä¸‹æ¬¡çƒ­æ›´æ–°çš„æ ‡è¯†ã€‚</p>
  <p>ç„¶åçœ‹ä¸€ä¸‹ï¼Œæ–°ç”Ÿæˆçš„æ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿæ¯æ¬¡ä¿®æ”¹ä»£ç ï¼Œç´§æ¥ç€è§¦å‘é‡æ–°ç¼–è¯‘ï¼Œç„¶åæµè§ˆå™¨å°±ä¼šå‘å‡º 2 æ¬¡è¯·æ±‚ã€‚è¯·æ±‚çš„ä¾¿æ˜¯æœ¬æ¬¡æ–°ç”Ÿæˆçš„ 2 ä¸ªæ–‡ä»¶ã€‚å¦‚ä¸‹ï¼š
  </p><figure><img alt="æµè§ˆå™¨è¯·æ±‚" src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec04289af752da~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure>
  é¦–å…ˆçœ‹<code>json</code>æ–‡ä»¶ï¼Œè¿”å›çš„ç»“æœä¸­ï¼Œ<code>h</code>ä»£è¡¨æœ¬æ¬¡æ–°ç”Ÿæˆçš„<code>Hash</code>å€¼ï¼Œç”¨äºä¸‹æ¬¡æ–‡ä»¶çƒ­æ›´æ–°è¯·æ±‚çš„å‰ç¼€ã€‚<code>c</code>è¡¨ç¤ºå½“å‰è¦çƒ­æ›´æ–°çš„æ–‡ä»¶å¯¹åº”çš„æ˜¯<code>index</code>æ¨¡å—ã€‚<p></p>
  <p>å†çœ‹ä¸‹ç”Ÿæˆçš„<code>js</code>æ–‡ä»¶ï¼Œé‚£å°±æ˜¯æœ¬æ¬¡ä¿®æ”¹çš„ä»£ç ï¼Œé‡æ–°ç¼–è¯‘æ‰“åŒ…åçš„ã€‚
  </p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec04316d6ac5e3~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure>
  è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•ä»£ç æ”¹åŠ¨ï¼Œç›´æ¥ä¿å­˜æ–‡ä»¶ï¼Œæ§åˆ¶å°ä¹Ÿä¼šè¾“å‡ºç¼–è¯‘æ‰“åŒ…ä¿¡æ¯çš„ã€‚<p></p>
  <ul>
    <li><strong>æ–°çš„Hashå€¼</strong>ï¼š<code>d2e4208eca62aa1c5389</code></li>
    <li><strong>æ–°çš„jsonæ–‡ä»¶</strong>ï¼š<code>a61bdd6e82294ed06fa3.hot-update.json</code></li>
  </ul>
  <p></p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec04bd0d47eae4~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p>ä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼Œå¹¶æ²¡æœ‰ç”Ÿæˆæ–°çš„<code>js</code>æ–‡ä»¶ï¼Œå› ä¸ºæ²¡æœ‰æ”¹åŠ¨ä»»ä½•ä»£ç ï¼ŒåŒæ—¶æµè§ˆå™¨å‘å‡ºçš„è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°<code>c</code>å€¼ä¸ºç©ºï¼Œä»£è¡¨æœ¬æ¬¡æ²¡æœ‰éœ€è¦æ›´æ–°çš„ä»£ç ã€‚
  </p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec04c7b158cb3b~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p>å°å£°è¯´ä¸‹ï¼Œ<code>webapck</code>ä»¥å‰çš„ç‰ˆæœ¬è¿™ç§æƒ…å†µ<code>hash</code>å€¼æ˜¯ä¸ä¼šå˜çš„ï¼Œåé¢å¯èƒ½å‡ºäºä»€ä¹ˆåŸå› æ”¹ç‰ˆäº†ã€‚ç»†èŠ‚ä¸ç”¨åœ¨æ„ï¼Œäº†è§£åŸç†æ‰æ˜¯çœŸè°›!!!</p>
  <p>æœ€åæ€è€ƒä¸‹ğŸ¤”ï¼Œæµè§ˆå™¨æ˜¯å¦‚ä½•çŸ¥é“æœ¬åœ°ä»£ç é‡æ–°ç¼–è¯‘äº†ï¼Œå¹¶è¿…é€Ÿè¯·æ±‚äº†æ–°ç”Ÿæˆçš„æ–‡ä»¶ï¼Ÿæ˜¯è°å‘ŠçŸ¥äº†æµè§ˆå™¨ï¼Ÿæµè§ˆå™¨è·å¾—è¿™äº›æ–‡ä»¶åˆæ˜¯å¦‚ä½•çƒ­æ›´æ–°æˆåŠŸçš„ï¼Ÿé‚£è®©æˆ‘ä»¬å¸¦ç€ç–‘é—®çœ‹ä¸‹çƒ­æ›´æ–°çš„è¿‡ç¨‹ï¼Œä»æºç çš„è§’åº¦çœ‹åŸç†ã€‚</p>
  <h2 class="heading" data-id="heading-2">ä¸‰ã€çƒ­æ›´æ–°å®ç°åŸç†</h2>
  <p>ç›¸ä¿¡å¤§å®¶éƒ½ä¼šé…ç½®<code>webpack-dev-server</code>çƒ­æ›´æ–°ï¼Œæˆ‘å°±ä¸ç¤ºæ„ä¾‹å­äº†ã€‚è‡ªå·±ç½‘ä¸ŠæŸ¥ä¸‹å³å¯ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹ä¸‹<code>webpack-dev-server</code>æ˜¯å¦‚ä½•å®ç°çƒ­æ›´æ–°çš„ï¼Ÿï¼ˆæºç éƒ½æ˜¯ç²¾ç®€è¿‡çš„ï¼Œç¬¬ä¸€è¡Œä¼šæ³¨æ˜ä»£ç è·¯å¾„ï¼Œçœ‹å®Œæœ€å¥½ç»“åˆæºç é£Ÿç”¨ä¸€æ¬¡ï¼‰ã€‚</p>
  <h3 class="heading" data-id="heading-3">1. webpack-dev-serverå¯åŠ¨æœ¬åœ°æœåŠ¡</h3>
  <p>æˆ‘ä»¬æ ¹æ®<code>webpack-dev-server</code>çš„<code>package.json</code>ä¸­çš„<code>bin</code>å‘½ä»¤ï¼Œå¯ä»¥æ‰¾åˆ°å‘½ä»¤çš„å…¥å£æ–‡ä»¶<code>bin/webpack-dev-server.js</code>ã€‚</p>
  <pre><code class="hljs javaScript copyable hljs language-pgsql" lang="pgsql">// node_modules/webpack-dev-<span class="hljs-keyword">server</span>/bin/webpack-dev-<span class="hljs-keyword">server</span>.js

// ç”Ÿæˆwebpackç¼–è¯‘ä¸»å¼•æ“ compiler
let compiler = webpack(config);

// å¯åŠ¨æœ¬åœ°æœåŠ¡
let <span class="hljs-keyword">server</span> = <span class="hljs-built_in">new</span> <span class="hljs-keyword">Server</span>(compiler, <span class="hljs-keyword">options</span>, <span class="hljs-keyword">log</span>);
<span class="hljs-keyword">server</span>.<span class="hljs-keyword">listen</span>(<span class="hljs-keyword">options</span>.port, <span class="hljs-keyword">options</span>.host, (err) =&gt; {
    <span class="hljs-keyword">if</span> (err) {throw err};
});<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p>æœ¬åœ°æœåŠ¡ä»£ç ï¼š</p>
  <pre><code class="hljs javascript copyable hljs language-javascript" lang="javascript"><span class="hljs-comment">// node_modules/webpack-dev-server/lib/Server.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setupApp</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createServer</span>();
    }

    <span class="hljs-title function_">setupApp</span>(<span class="hljs-params"></span>) {
        <span class="hljs-comment">// ä¾èµ–äº†express</span>
    	<span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">express</span>();
    }

    <span class="hljs-title function_">createServer</span>(<span class="hljs-params"></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeningApp</span> = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>);
    }
    <span class="hljs-title function_">listen</span>(<span class="hljs-params">port, hostname, fn</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeningApp</span>.<span class="hljs-title function_">listen</span>(port, hostname, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            <span class="hljs-comment">// å¯åŠ¨expressæœåŠ¡åï¼Œå¯åŠ¨websocketæœåŠ¡</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createSocketServer</span>();
        }
    }
}<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p>è¿™ä¸€å°èŠ‚ä»£ç ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š</p>
  <ul>
    <li>å¯åŠ¨<code>webpack</code>ï¼Œç”Ÿæˆ<code>compiler</code>å®ä¾‹ã€‚<code>compiler</code>ä¸Šæœ‰å¾ˆå¤šæ–¹æ³•ï¼Œæ¯”å¦‚å¯ä»¥å¯åŠ¨ <code>webpack</code> æ‰€æœ‰<strong>ç¼–è¯‘</strong>å·¥ä½œï¼Œä»¥åŠ<strong>ç›‘å¬</strong>æœ¬åœ°æ–‡ä»¶çš„å˜åŒ–ã€‚</li>
    <li>ä½¿ç”¨<code>express</code>æ¡†æ¶å¯åŠ¨æœ¬åœ°<code>server</code>ï¼Œè®©æµè§ˆå™¨å¯ä»¥è¯·æ±‚æœ¬åœ°çš„<strong>é™æ€èµ„æº</strong>ã€‚</li>
    <li>æœ¬åœ°<code>server</code>å¯åŠ¨ä¹‹åï¼Œå†å»å¯åŠ¨<code>websocket</code>æœåŠ¡ï¼Œå¦‚æœä¸äº†è§£<code>websocket</code>ï¼Œå»ºè®®ç®€å•äº†è§£ä¸€ä¸‹<a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2017%2F05%2Fwebsocket.html" title="https://www.ruanyifeng.com/blog/2017/05/websocket.html" ref="nofollow noopener noreferrer">websocketé€Ÿæˆ</a>ã€‚é€šè¿‡<code>websocket</code>ï¼Œå¯ä»¥å»ºç«‹æœ¬åœ°æœåŠ¡å’Œæµè§ˆå™¨çš„åŒå‘é€šä¿¡ã€‚è¿™æ ·å°±å¯ä»¥å®ç°å½“æœ¬åœ°æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œç«‹é©¬å‘ŠçŸ¥æµè§ˆå™¨å¯ä»¥çƒ­æ›´æ–°ä»£ç å•¦ï¼</li>
  </ul>
  <p>ä¸Šè¿°ä»£ç ä¸»è¦å¹²äº†ä¸‰ä»¶äº‹ï¼Œä½†æ˜¯æºç åœ¨å¯åŠ¨æœåŠ¡å‰åˆåšäº†å¾ˆå¤šäº‹ï¼Œæ¥ä¸‹æ¥ä¾¿çœ‹çœ‹<code>webpack-dev-server/lib/Server.js</code>è¿˜åšäº†å“ªäº›äº‹ï¼Ÿ</p>
  <h3 class="heading" data-id="heading-4">2. ä¿®æ”¹webpack.config.jsçš„entryé…ç½®</h3>
  <p>å¯åŠ¨æœ¬åœ°æœåŠ¡å‰ï¼Œè°ƒç”¨äº†<code>updateCompiler(this.compiler)</code>æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¸­æœ‰ 2 æ®µå…³é”®æ€§ä»£ç ã€‚ä¸€ä¸ªæ˜¯è·å–<code>websocket</code>å®¢æˆ·ç«¯ä»£ç è·¯å¾„ï¼Œå¦ä¸€ä¸ªæ˜¯æ ¹æ®é…ç½®è·å–<code>webpack</code>çƒ­æ›´æ–°ä»£ç è·¯å¾„ã€‚</p>
  <pre><code class="hljs javascript copyable hljs language-javascript" lang="javascript"><span class="hljs-comment">// è·å–websocketå®¢æˆ·ç«¯ä»£ç </span>
<span class="hljs-keyword">const</span> clientEntry = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">require</span>.resolve(
    <span class="hljs-string">'../../client/'</span>
)}</span>?<span class="hljs-subst">${domain}</span><span class="hljs-subst">${sockHost}</span><span class="hljs-subst">${sockPath}</span><span class="hljs-subst">${sockPort}</span>`</span>;

<span class="hljs-comment">// æ ¹æ®é…ç½®è·å–çƒ­æ›´æ–°ä»£ç </span>
<span class="hljs-keyword">let</span> hotEntry;
<span class="hljs-keyword">if</span> (options.<span class="hljs-property">hotOnly</span>) {
    hotEntry = <span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'webpack/hot/only-dev-server'</span>);
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.<span class="hljs-property">hot</span>) {
    hotEntry = <span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'webpack/hot/dev-server'</span>);
}<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p>ä¿®æ”¹åçš„<code>webpack</code>å…¥å£é…ç½®å¦‚ä¸‹ï¼š</p>
  <pre><code class="hljs javascript copyable hljs language-awk" lang="awk"><span class="hljs-regexp">//</span> ä¿®æ”¹åçš„entryå…¥å£
{ entry:
    { index:
        [
            <span class="hljs-regexp">//</span> ä¸Šé¢è·å–çš„clientEntry
            <span class="hljs-string">'xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:8080'</span>,
            <span class="hljs-regexp">//</span> ä¸Šé¢è·å–çš„hotEntry
            <span class="hljs-string">'xxx/node_modules/webpack/hot/dev-server.js'</span>,
            <span class="hljs-regexp">//</span> å¼€å‘é…ç½®çš„å…¥å£
            <span class="hljs-string">'./src/index.js'</span>
    	],
    },
}      <span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p>ä¸ºä»€ä¹ˆè¦æ–°å¢äº† 2 ä¸ªæ–‡ä»¶ï¼Ÿåœ¨å…¥å£é»˜é»˜å¢åŠ äº† 2 ä¸ªæ–‡ä»¶ï¼Œé‚£å°±æ„å‘³ä¼šä¸€åŒæ‰“åŒ…åˆ°<code>bundle</code>æ–‡ä»¶ä¸­å»ï¼Œä¹Ÿå°±æ˜¯çº¿ä¸Šè¿è¡Œæ—¶ã€‚</p>
  <p><strong>ï¼ˆ1ï¼‰webpack-dev-server/client/index.js</strong></p>
  <p>é¦–å…ˆè¿™ä¸ªæ–‡ä»¶ç”¨äº<code>websocket</code>çš„ï¼Œå› ä¸º<code>websoket</code>æ˜¯åŒå‘é€šä¿¡ï¼Œå¦‚æœä¸äº†è§£<code>websocket</code>ï¼Œå»ºè®®ç®€å•äº†è§£ä¸€ä¸‹<a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2017%2F05%2Fwebsocket.html" title="https://www.ruanyifeng.com/blog/2017/05/websocket.html" ref="nofollow noopener noreferrer">websocketé€Ÿæˆ</a>ã€‚æˆ‘ä»¬åœ¨ç¬¬ 1 æ­¥ <code>webpack-dev-server</code>åˆå§‹åŒ– çš„è¿‡ç¨‹ä¸­ï¼Œå¯åŠ¨çš„æ˜¯æœ¬åœ°æœåŠ¡ç«¯çš„<code>websocket</code>ã€‚é‚£å®¢æˆ·ç«¯ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„æµè§ˆå™¨ï¼Œæµè§ˆå™¨è¿˜æ²¡æœ‰å’ŒæœåŠ¡ç«¯é€šä¿¡çš„ä»£ç å‘¢ï¼Ÿæ€»ä¸èƒ½è®©å¼€å‘è€…å»å†™å§hhhhhhã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æŠŠ<code>websocket</code>å®¢æˆ·ç«¯é€šä¿¡ä»£ç å·å·å¡åˆ°æˆ‘ä»¬çš„ä»£ç ä¸­ã€‚å®¢æˆ·ç«¯å…·ä½“çš„ä»£ç åé¢ä¼šåœ¨åˆé€‚çš„æ—¶æœºç»†è®²å“¦ã€‚</p>
  <p><strong>ï¼ˆ2ï¼‰webpack/hot/dev-server.js</strong></p>
  <p>è¿™ä¸ªæ–‡ä»¶ä¸»è¦æ˜¯ç”¨äºæ£€æŸ¥æ›´æ–°é€»è¾‘çš„ï¼Œè¿™é‡Œå¤§å®¶çŸ¥é“å°±å¥½ï¼Œä»£ç åé¢ä¼šåœ¨åˆé€‚çš„æ—¶æœºï¼ˆ<strong>ç¬¬5æ­¥</strong>ï¼‰ç»†è®²ã€‚</p>
  <h3 class="heading" data-id="heading-5">3. ç›‘å¬webpackç¼–è¯‘ç»“æŸ</h3>
  <p>ä¿®æ”¹å¥½å…¥å£é…ç½®åï¼Œåˆè°ƒç”¨äº†<code>setupHooks</code>æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥æ³¨å†Œç›‘å¬äº‹ä»¶çš„ï¼Œç›‘å¬æ¯æ¬¡<code>webpack</code>ç¼–è¯‘å®Œæˆã€‚</p>
  <pre><code class="hljs javascript copyable hljs language-javascript" lang="javascript"><span class="hljs-comment">// node_modules/webpack-dev-server/lib/Server.js</span>
<span class="hljs-comment">// ç»‘å®šç›‘å¬äº‹ä»¶</span>
<span class="hljs-title function_">setupHooks</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> {done} = compiler.<span class="hljs-property">hooks</span>;
    <span class="hljs-comment">// ç›‘å¬webpackçš„doneé’©å­ï¼Œtapableæä¾›çš„ç›‘å¬æ–¹æ³•</span>
    done.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'webpack-dev-server'</span>, <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_sendStats</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sockets</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getStats</span>(stats));
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_stats</span> = stats;
    });
};<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p>å½“ç›‘å¬åˆ°ä¸€æ¬¡<code>webpack</code>ç¼–è¯‘ç»“æŸï¼Œå°±ä¼šè°ƒç”¨<code>_sendStats</code>æ–¹æ³•é€šè¿‡<code>websocket</code>ç»™æµè§ˆå™¨å‘é€é€šçŸ¥ï¼Œ<code>ok</code>å’Œ<code>hash</code>äº‹ä»¶ï¼Œè¿™æ ·æµè§ˆå™¨å°±å¯ä»¥æ‹¿åˆ°æœ€æ–°çš„<code>hash</code>å€¼äº†ï¼Œåšæ£€æŸ¥æ›´æ–°é€»è¾‘ã€‚</p>
  <pre><code class="hljs bash copyable hljs language-reasonml" lang="reasonml"><span class="hljs-comment">// é€šè¿‡websoketç»™å®¢æˆ·ç«¯å‘æ¶ˆæ¯</span>
<span class="hljs-constructor">_sendStats()</span> {
    this.sock<span class="hljs-constructor">Write(<span class="hljs-params">sockets</span>, '<span class="hljs-params">hash</span>', <span class="hljs-params">stats</span>.<span class="hljs-params">hash</span>)</span>;
    this.sock<span class="hljs-constructor">Write(<span class="hljs-params">sockets</span>, '<span class="hljs-params">ok</span>')</span>;
}<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><h3 class="heading" data-id="heading-6">4. webpackç›‘å¬æ–‡ä»¶å˜åŒ–</h3>
  <p>æ¯æ¬¡ä¿®æ”¹ä»£ç ï¼Œå°±ä¼šè§¦å‘ç¼–è¯‘ã€‚è¯´æ˜æˆ‘ä»¬è¿˜éœ€è¦ç›‘å¬æœ¬åœ°ä»£ç çš„å˜åŒ–ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>setupDevMiddleware</code>æ–¹æ³•å®ç°çš„ã€‚</p>
  <p>è¿™ä¸ªæ–¹æ³•ä¸»è¦æ‰§è¡Œäº†<code>webpack-dev-middleware</code>åº“ã€‚å¾ˆå¤šäººåˆ†ä¸æ¸…<code>webpack-dev-middleware</code>å’Œ<code>webpack-dev-server</code>çš„åŒºåˆ«ã€‚å…¶å®å°±æ˜¯å› ä¸º<code>webpack-dev-server</code>åªè´Ÿè´£å¯åŠ¨æœåŠ¡å’Œå‰ç½®å‡†å¤‡å·¥ä½œï¼Œæ‰€æœ‰æ–‡ä»¶ç›¸å…³çš„æ“ä½œéƒ½æŠ½ç¦»åˆ°<code>webpack-dev-middleware</code>åº“äº†ï¼Œä¸»è¦æ˜¯æœ¬åœ°æ–‡ä»¶çš„<strong>ç¼–è¯‘</strong>å’Œ<strong>è¾“å‡º</strong>ä»¥åŠ<strong>ç›‘å¬</strong>ï¼Œæ— éå°±æ˜¯èŒè´£çš„åˆ’åˆ†æ›´æ¸…æ™°äº†ã€‚</p>
  <p>é‚£æˆ‘ä»¬æ¥çœ‹ä¸‹<code>webpack-dev-middleware</code>æºç é‡Œåšäº†ä»€ä¹ˆäº‹:</p>
  <pre><code class="hljs javascript copyable hljs language-awk" lang="awk"><span class="hljs-regexp">//</span> node_modules<span class="hljs-regexp">/webpack-dev-middleware/i</span>ndex.js
compiler.watch(options.watchOptions, (err) =&gt; {
    <span class="hljs-keyword">if</span> (err) { <span class="hljs-regexp">/*é”™è¯¯å¤„ç†*/</span> }
});

<span class="hljs-regexp">//</span> é€šè¿‡â€œmemory-fsâ€åº“å°†æ‰“åŒ…åçš„æ–‡ä»¶å†™å…¥å†…å­˜
setFs(context, compiler); <span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p>ï¼ˆ1ï¼‰è°ƒç”¨äº†<code>compiler.watch</code>æ–¹æ³•ï¼Œåœ¨ç¬¬ 1 æ­¥ä¸­ä¹Ÿæåˆ°è¿‡ï¼Œ<code>compiler</code>çš„å¼ºå¤§ã€‚è¿™ä¸ªæ–¹æ³•ä¸»è¦å°±åšäº† 2 ä»¶äº‹ï¼š</p>
  <ul>
    <li>é¦–å…ˆå¯¹æœ¬åœ°æ–‡ä»¶ä»£ç è¿›è¡Œç¼–è¯‘æ‰“åŒ…ï¼Œä¹Ÿå°±æ˜¯<code>webpack</code>çš„ä¸€ç³»åˆ—ç¼–è¯‘æµç¨‹ã€‚</li>
    <li>å…¶æ¬¡ç¼–è¯‘ç»“æŸåï¼Œå¼€å¯å¯¹æœ¬åœ°æ–‡ä»¶çš„ç›‘å¬ï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°ç¼–è¯‘ï¼Œç¼–è¯‘å®Œæˆä¹‹åç»§ç»­ç›‘å¬ã€‚</li>
  </ul>
  <p>ä¸ºä»€ä¹ˆä»£ç çš„æ”¹åŠ¨ä¿å­˜ä¼šè‡ªåŠ¨ç¼–è¯‘ï¼Œé‡æ–°æ‰“åŒ…ï¼Ÿè¿™ä¸€ç³»åˆ—çš„é‡æ–°æ£€æµ‹ç¼–è¯‘å°±å½’åŠŸäº<code>compiler.watch</code>è¿™ä¸ªæ–¹æ³•äº†ã€‚ç›‘å¬æœ¬åœ°æ–‡ä»¶çš„å˜åŒ–ä¸»è¦æ˜¯é€šè¿‡<strong>æ–‡ä»¶çš„ç”Ÿæˆæ—¶é—´</strong>æ˜¯å¦æœ‰å˜åŒ–ï¼Œè¿™é‡Œå°±ä¸ç»†è®²äº†ã€‚</p>
  <p>ï¼ˆ2ï¼‰æ‰§è¡Œ<code>setFs</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦ç›®çš„å°±æ˜¯å°†ç¼–è¯‘åçš„æ–‡ä»¶æ‰“åŒ…åˆ°å†…å­˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¼šå‘ç°<code>dist</code>ç›®å½•æ²¡æœ‰æ‰“åŒ…åçš„ä»£ç ï¼Œå› ä¸ºéƒ½åœ¨å†…å­˜ä¸­ã€‚åŸå› å°±åœ¨äºè®¿é—®å†…å­˜ä¸­çš„ä»£ç æ¯”è®¿é—®æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æ›´å¿«ï¼Œè€Œä¸”ä¹Ÿå‡å°‘äº†ä»£ç å†™å…¥æ–‡ä»¶çš„å¼€é”€ï¼Œè¿™ä¸€åˆ‡éƒ½å½’åŠŸäº<code>memory-fs</code>ã€‚</p>
  <h3 class="heading" data-id="heading-7">5. æµè§ˆå™¨æ¥æ”¶åˆ°çƒ­æ›´æ–°çš„é€šçŸ¥</h3>
  <p>æˆ‘ä»¬å·²ç»å¯ä»¥ç›‘å¬åˆ°æ–‡ä»¶çš„å˜åŒ–äº†ï¼Œå½“æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œå°±è§¦å‘é‡æ–°ç¼–è¯‘ã€‚åŒæ—¶è¿˜ç›‘å¬äº†æ¯æ¬¡ç¼–è¯‘ç»“æŸçš„äº‹ä»¶ã€‚å½“ç›‘å¬åˆ°ä¸€æ¬¡<code>webpack</code>ç¼–è¯‘ç»“æŸï¼Œ<code>_sendStats</code>æ–¹æ³•å°±é€šè¿‡<code>websoket</code>ç»™æµè§ˆå™¨å‘é€é€šçŸ¥ï¼Œæ£€æŸ¥ä¸‹æ˜¯å¦éœ€è¦çƒ­æ›´æ–°ã€‚ä¸‹é¢é‡ç‚¹è®²çš„å°±æ˜¯<code>_sendStats</code>æ–¹æ³•ä¸­çš„<code>ok</code>å’Œ<code>hash</code>äº‹ä»¶éƒ½åšäº†ä»€ä¹ˆã€‚</p>
  <p>é‚£æµè§ˆå™¨æ˜¯å¦‚ä½•æ¥æ”¶åˆ°<code>websocket</code>çš„æ¶ˆæ¯å‘¢ï¼Ÿå›å¿†ä¸‹ç¬¬ 2 æ­¥éª¤å¢åŠ çš„å…¥å£æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯<code>websocket</code>å®¢æˆ·ç«¯ä»£ç ã€‚</p>
  <pre><code class="hljs javascript copyable hljs language-1c" lang="1c">'xxx/node_modules/webpack-dev-server/client/index.js?http://localhost:<span class="hljs-number">8080</span>'<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p>è¿™ä¸ªæ–‡ä»¶çš„ä»£ç ä¼šè¢«æ‰“åŒ…åˆ°<code>bundle.js</code>ä¸­ï¼Œè¿è¡Œåœ¨æµè§ˆå™¨ä¸­ã€‚æ¥çœ‹ä¸‹è¿™ä¸ªæ–‡ä»¶çš„æ ¸å¿ƒä»£ç å§ã€‚</p>
  <pre><code class="hljs javascript copyable hljs language-awk" lang="awk"><span class="hljs-regexp">//</span> webpack-dev-server<span class="hljs-regexp">/client/i</span>ndex.js
var socket = require(<span class="hljs-string">'./socket'</span>);
var onSocketMessage = {
    hash: <span class="hljs-keyword">function</span> hash(_hash) {
        <span class="hljs-regexp">//</span> æ›´æ–°currentHashå€¼
        status.currentHash = _hash;
    },
    ok: <span class="hljs-keyword">function</span> ok() {
        sendMessage(<span class="hljs-string">'Ok'</span>);
        <span class="hljs-regexp">//</span> è¿›è¡Œæ›´æ–°æ£€æŸ¥ç­‰æ“ä½œ
        reloadApp(options, status);
    },
};
<span class="hljs-regexp">//</span> è¿æ¥æœåŠ¡åœ°å€socketUrlï¼Œ?http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8080</span>ï¼Œæœ¬åœ°æœåŠ¡åœ°å€
socket(socketUrl, onSocketMessage);

<span class="hljs-keyword">function</span> reloadApp() {
	<span class="hljs-keyword">if</span> (hot) {
        log.info(<span class="hljs-string">'[WDS] App hot update...'</span>);

        <span class="hljs-regexp">//</span> hotEmitterå…¶å®å°±æ˜¯EventEmitterçš„å®ä¾‹
        var hotEmitter = require(<span class="hljs-string">'webpack/hot/emitter'</span>);
        hotEmitter.emit(<span class="hljs-string">'webpackHotUpdate'</span>, currentHash);
    }
}<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p><code>socket</code>æ–¹æ³•å»ºç«‹äº†<code>websocket</code>å’ŒæœåŠ¡ç«¯çš„è¿æ¥ï¼Œå¹¶æ³¨å†Œäº† 2 ä¸ªç›‘å¬äº‹ä»¶ã€‚</p>
  <ul>
    <li><code>hash</code>äº‹ä»¶ï¼Œæ›´æ–°æœ€æ–°ä¸€æ¬¡æ‰“åŒ…åçš„<code>hash</code>å€¼ã€‚</li>
    <li><code>ok</code>äº‹ä»¶ï¼Œè¿›è¡Œçƒ­æ›´æ–°æ£€æŸ¥ã€‚</li>
  </ul>
  <p>çƒ­æ›´æ–°æ£€æŸ¥äº‹ä»¶æ˜¯è°ƒç”¨<code>reloadApp</code>æ–¹æ³•ã€‚æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•åˆåˆ©ç”¨<code>node.js</code>çš„<code>EventEmitter</code>ï¼Œå‘å‡º<code>webpackHotUpdate</code>æ¶ˆæ¯ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥è¿›è¡Œæ£€æŸ¥æ›´æ–°å‘¢ï¼Ÿ</p>
  <p>ä¸ªäººç†è§£å°±æ˜¯ä¸ºäº†æ›´å¥½çš„ç»´æŠ¤ä»£ç ï¼Œä»¥åŠèŒè´£åˆ’åˆ†çš„æ›´æ˜ç¡®ã€‚<code>websocket</code>ä»…ä»…ç”¨äºå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰å’ŒæœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ã€‚è€ŒçœŸæ­£åšäº‹æƒ…çš„æ´»è¿˜æ˜¯äº¤å›ç»™äº†<code>webpack</code>ã€‚</p>
  <p>é‚£<code>webpack</code>æ€ä¹ˆåšçš„å‘¢ï¼Ÿå†æ¥å›å¿†ä¸‹ç¬¬ 2 æ­¥ã€‚å…¥å£æ–‡ä»¶è¿˜æœ‰ä¸€ä¸ªæ–‡ä»¶æ²¡æœ‰è®²åˆ°ï¼Œå°±æ˜¯ï¼š</p>
  <pre><code class="hljs javascript copyable hljs language-scheme" lang="scheme"><span class="hljs-symbol">'xxx/node_modules/webpack/hot/dev-server.js</span>'<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p>è¿™ä¸ªæ–‡ä»¶çš„ä»£ç åŒæ ·ä¼šè¢«æ‰“åŒ…åˆ°<code>bundle.js</code>ä¸­ï¼Œè¿è¡Œåœ¨æµè§ˆå™¨ä¸­ã€‚è¿™ä¸ªæ–‡ä»¶åšäº†ä»€ä¹ˆå°±æ˜¾è€Œæ˜“è§äº†å§ï¼å…ˆç„ä¸€çœ¼ä»£ç ï¼š</p>
  <pre><code class="hljs javascript copyable hljs language-javascript" lang="javascript"><span class="hljs-comment">// node_modules/webpack/hot/dev-server.js</span>
<span class="hljs-keyword">var</span> check = <span class="hljs-keyword">function</span> <span class="hljs-title function_">check</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">check</span>(<span class="hljs-literal">true</span>)
        .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">updatedModules</span>) {
            <span class="hljs-comment">// å®¹é”™ï¼Œç›´æ¥åˆ·æ–°é¡µé¢</span>
            <span class="hljs-keyword">if</span> (!updatedModules) {
                <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>();
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// çƒ­æ›´æ–°ç»“æŸï¼Œæ‰“å°ä¿¡æ¯</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-title function_">upToDate</span>()) {
                <span class="hljs-title function_">log</span>(<span class="hljs-string">"info"</span>, <span class="hljs-string">"[HMR] App is up to date."</span>);
            }
    })
        .<span class="hljs-title function_">catch</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>();
        });
};

<span class="hljs-keyword">var</span> hotEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./emitter"</span>);
hotEmitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">"webpackHotUpdate"</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">currentHash</span>) {
    lastHash = currentHash;
    <span class="hljs-title function_">check</span>();
});<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p>è¿™é‡Œ<code>webpack</code>ç›‘å¬åˆ°äº†<code>webpackHotUpdate</code>äº‹ä»¶ï¼Œå¹¶è·å–æœ€æ–°äº†æœ€æ–°çš„<code>hash</code>å€¼ï¼Œç„¶åç»ˆäºè¿›è¡Œæ£€æŸ¥æ›´æ–°äº†ã€‚æ£€æŸ¥æ›´æ–°å‘¢è°ƒç”¨çš„æ˜¯<code>module.hot.check</code>æ–¹æ³•ã€‚é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œ<code>module.hot.check</code>åˆæ˜¯å“ªé‡Œå†’å‡ºæ¥äº†çš„ï¼ç­”æ¡ˆæ˜¯<code>HotModuleReplacementPlugin</code>æå¾—é¬¼ã€‚è¿™é‡Œç•™ä¸ªç–‘é—®ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
  <h3 class="heading" data-id="heading-8">6. HotModuleReplacementPlugin</h3>
  <p>å‰é¢å¥½åƒä¸€ç›´æ˜¯<code>webpack-dev-server</code>åšçš„äº‹ï¼Œé‚£<code>HotModuleReplacementPlugin</code>åœ¨çƒ­æ›´æ–°è¿‡ç¨‹ä¸­åˆåšäº†ä»€ä¹ˆä¼Ÿå¤§çš„äº‹ä¸šå‘¢ï¼Ÿ</p>
  <p>é¦–å…ˆä½ å¯ä»¥å¯¹æ¯”ä¸‹ï¼Œé…ç½®çƒ­æ›´æ–°å’Œä¸é…ç½®æ—¶<code>bundle.js</code>çš„åŒºåˆ«ã€‚å†…å­˜ä¸­çœ‹ä¸åˆ°ï¼Ÿç›´æ¥æ‰§è¡Œ<code>webpack</code>å‘½ä»¤å°±å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„<code>bundle.js</code>æ–‡ä»¶å•¦ã€‚ä¸è¦ç”¨<code>webpack-dev-server</code>å¯åŠ¨å°±å¥½äº†ã€‚</p>
  <p>ï¼ˆ1ï¼‰æ²¡æœ‰é…ç½®çš„ã€‚
  </p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec0c9e8fd12349~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure>
  ï¼ˆ2ï¼‰é…ç½®äº†<code>HotModuleReplacementPlugin</code>æˆ–<code>--hot</code>çš„ã€‚
  <figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec0c90092fa0ac~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure>
  å“¦~ æˆ‘ä»¬å‘ç°<code>moudle</code>æ–°å¢äº†ä¸€ä¸ªå±æ€§ä¸º<code>hot</code>ï¼Œå†çœ‹<code>hotCreateModule</code>æ–¹æ³•ã€‚
  è¿™ä¸å°±æ‰¾åˆ°<code>module.hot.check</code>æ˜¯å“ªé‡Œå†’å‡ºæ¥çš„ã€‚
  <figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec0dc36018973f~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p>ç»è¿‡å¯¹æ¯”æ‰“åŒ…åçš„æ–‡ä»¶ï¼Œ<code>__webpack_require__</code>ä¸­çš„<code>moudle</code>ä»¥åŠä»£ç è¡Œæ•°çš„ä¸åŒã€‚æˆ‘ä»¬éƒ½å¯ä»¥å‘ç°<code>HotModuleReplacementPlugin</code>åŸæ¥ä¹Ÿæ˜¯é»˜é»˜çš„å¡äº†å¾ˆå¤šä»£ç åˆ°<code>bundle.js</code>ä¸­å‘€ã€‚è¿™å’Œç¬¬ 2 æ­¥éª¤å¾ˆæ˜¯ç›¸ä¼¼å“¦ï¼ä¸ºä»€ä¹ˆï¼Œå› ä¸ºæ£€æŸ¥æ›´æ–°æ˜¯åœ¨æµè§ˆå™¨ä¸­æ“ä½œå‘€ã€‚è¿™äº›ä»£ç å¿…é¡»åœ¨è¿è¡Œæ—¶çš„ç¯å¢ƒã€‚</p>
  <p>ä½ ä¹Ÿå¯ä»¥ç›´æ¥çœ‹æµè§ˆå™¨<code>Sources</code>ä¸‹çš„ä»£ç ï¼Œä¼šå‘ç°<code>webpack</code>å’Œ<code>plugin</code>å·å·åŠ çš„ä»£ç éƒ½åœ¨å“¦ã€‚åœ¨è¿™é‡Œè°ƒè¯•ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚
  </p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec0d4634af2b3c~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure>
  <code>HotModuleReplacementPlugin</code>å¦‚ä½•åšåˆ°çš„ï¼Ÿè¿™é‡Œæˆ‘å°±ä¸è®²äº†ï¼Œå› ä¸ºè¿™éœ€è¦ä½ å¯¹<code>tapable</code>ä»¥åŠ<code>plugin</code>æœºåˆ¶æœ‰ä¸€å®šäº†è§£ï¼Œå¯ä»¥çœ‹ä¸‹æˆ‘å†™çš„æ–‡ç« <a target="_blank" href="https://juejin.cn/post/6844904004435050503" title="https://juejin.cn/post/6844904004435050503">Webpackæ’ä»¶æœºåˆ¶ä¹‹Tapable-æºç è§£æ</a>ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©è·³è¿‡ï¼Œåªå…³å¿ƒçƒ­æ›´æ–°æœºåˆ¶å³å¯ï¼Œæ¯•ç«Ÿä¿¡æ¯é‡å¤ªå¤§ã€‚<p></p>
  <h3 class="heading" data-id="heading-9">7. moudle.hot.check å¼€å§‹çƒ­æ›´æ–°</h3>
  <p>é€šè¿‡ç¬¬ 6 æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“<code>moudle.hot.check</code>æ–¹æ³•æ˜¯å¦‚ä½•æ¥çš„å•¦ã€‚é‚£éƒ½åšäº†ä»€ä¹ˆï¼Ÿä¹‹åçš„æºç éƒ½æ˜¯<code>HotModuleReplacementPlugin</code>å¡å…¥åˆ°<code>bundle.js</code>ä¸­çš„å“¦ï¼Œæˆ‘å°±ä¸å†™æ–‡ä»¶è·¯å¾„äº†ã€‚</p>
  <ul>
    <li>åˆ©ç”¨ä¸Šä¸€æ¬¡ä¿å­˜çš„<code>hash</code>å€¼ï¼Œè°ƒç”¨<code>hotDownloadManifest</code>å‘é€<code>xxx/hash.hot-update.json</code>çš„<code>ajax</code>è¯·æ±‚ï¼›</li>
    <li>è¯·æ±‚ç»“æœè·å–çƒ­æ›´æ–°æ¨¡å—ï¼Œä»¥åŠä¸‹æ¬¡çƒ­æ›´æ–°çš„<code>Hash</code> æ ‡è¯†ï¼Œå¹¶è¿›å…¥çƒ­æ›´æ–°å‡†å¤‡é˜¶æ®µã€‚</li>
  </ul>
  <pre><code class="hljs javascript copyable hljs language-abnf" lang="abnf"><span class="hljs-attribute">hotAvailableFilesMap</span> <span class="hljs-operator">=</span> update.c<span class="hljs-comment">; // éœ€è¦æ›´æ–°çš„æ–‡ä»¶</span>
<span class="hljs-attribute">hotUpdateNewHash</span> <span class="hljs-operator">=</span> update.h<span class="hljs-comment">; // æ›´æ–°ä¸‹æ¬¡çƒ­æ›´æ–°hashå€¼</span>
hotSetStatus(<span class="hljs-string">"prepare"</span>)<span class="hljs-comment">; // è¿›å…¥çƒ­æ›´æ–°å‡†å¤‡çŠ¶æ€</span><span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><ul>
    <li>è°ƒç”¨<code>hotDownloadUpdateChunk</code>å‘é€<code>xxx/hash.hot-update.js</code> è¯·æ±‚ï¼Œé€šè¿‡<code>JSONP</code>æ–¹å¼ã€‚</li>
  </ul>
  <pre><code class="hljs javascript copyable hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hotDownloadUpdateChunk</span>(<span class="hljs-params">chunkId</span>) {
    <span class="hljs-keyword">var</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"script"</span>);
    script.<span class="hljs-property">charset</span> = <span class="hljs-string">"utf-8"</span>;
    script.<span class="hljs-property">src</span> = __webpack_require__.<span class="hljs-property">p</span> + <span class="hljs-string">""</span> + chunkId + <span class="hljs-string">"."</span> + hotCurrentHash + <span class="hljs-string">".hot-update.js"</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span>) script.<span class="hljs-property">crossOrigin</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
 }<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p>è¿™ä¸ªå‡½æ•°ä½“ä¸ºä»€ä¹ˆè¦å•ç‹¬æ‹¿å‡ºæ¥ï¼Œå› ä¸ºè¿™é‡Œè¦è§£é‡Šä¸‹ä¸ºä»€ä¹ˆä½¿ç”¨<code>JSONP</code>è·å–æœ€æ–°ä»£ç ï¼Ÿä¸»è¦æ˜¯å› ä¸º<code>JSONP</code>è·å–çš„ä»£ç å¯ä»¥ç›´æ¥æ‰§è¡Œã€‚ä¸ºä»€ä¹ˆè¦ç›´æ¥æ‰§è¡Œï¼Ÿæˆ‘ä»¬æ¥å›å¿†ä¸‹<code>/hash.hot-update.js</code>çš„ä»£ç æ ¼å¼æ˜¯æ€ä¹ˆæ ·çš„ã€‚
  </p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec04316d6ac5e3~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <p>å¯ä»¥å‘ç°ï¼Œæ–°ç¼–è¯‘åçš„ä»£ç æ˜¯åœ¨ä¸€ä¸ª<code>webpackHotUpdate</code>å‡½æ•°ä½“å†…éƒ¨çš„ã€‚ä¹Ÿå°±æ˜¯è¦ç«‹å³æ‰§è¡Œ<code>webpackHotUpdate</code>è¿™ä¸ªæ–¹æ³•ã€‚</p>
  <p>å†çœ‹ä¸‹<code>webpackHotUpdate</code>è¿™ä¸ªæ–¹æ³•ã€‚</p>
  <pre><code class="hljs javascript copyable hljs language-ada" lang="ada">window[<span class="hljs-string">"webpackHotUpdate"</span>] = <span class="hljs-keyword">function</span> <span class="hljs-title"></span>(chunkId, moreModules) {
    hotAddUpdateChunk(chunkId, moreModules);
} ;<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><ul>
    <li><code>hotAddUpdateChunk</code>æ–¹æ³•ä¼šæŠŠæ›´æ–°çš„æ¨¡å—<code>moreModules</code>èµ‹å€¼ç»™å…¨å±€å…¨é‡<code>hotUpdate</code>ã€‚</li>
    <li><code>hotUpdateDownloaded</code>æ–¹æ³•ä¼šè°ƒç”¨<code>hotApply</code>è¿›è¡Œä»£ç çš„æ›¿æ¢ã€‚</li>
  </ul>
  <pre><code class="hljs javascript copyable hljs language-reasonml" lang="reasonml"><span class="hljs-keyword">function</span> hot<span class="hljs-constructor">AddUpdateChunk(<span class="hljs-params">chunkId</span>, <span class="hljs-params">moreModules</span>)</span> {
    <span class="hljs-comment">// æ›´æ–°çš„æ¨¡å—moreModulesèµ‹å€¼ç»™å…¨å±€å…¨é‡hotUpdate</span>
    <span class="hljs-keyword">for</span> (var moduleId <span class="hljs-keyword">in</span> moreModules) {
        <span class="hljs-keyword">if</span> (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Object</span>.</span></span>prototype.hasOwnProperty.call(moreModules, moduleId)) {
	    hotUpdate<span class="hljs-literal">[<span class="hljs-identifier">moduleId</span>]</span> = moreModules<span class="hljs-literal">[<span class="hljs-identifier">moduleId</span>]</span>;
        }
    }
    <span class="hljs-comment">// è°ƒç”¨hotApplyè¿›è¡Œæ¨¡å—çš„æ›¿æ¢</span>
    hot<span class="hljs-constructor">UpdateDownloaded()</span>;
}<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><h3 class="heading" data-id="heading-10">8. hotApply çƒ­æ›´æ–°æ¨¡å—æ›¿æ¢</h3>
  <p>çƒ­æ›´æ–°çš„æ ¸å¿ƒé€»è¾‘å°±åœ¨<code>hotApply</code>æ–¹æ³•äº†ã€‚
    <code>hotApply</code>ä»£ç æœ‰å°†è¿‘ 400 è¡Œï¼Œè¿˜æ˜¯æŒ‘é‡ç‚¹è®²äº†ï¼Œçœ‹å“­ğŸ˜­</p>
  <h4 class="heading" data-id="heading-11">â‘ åˆ é™¤è¿‡æœŸçš„æ¨¡å—ï¼Œå°±æ˜¯éœ€è¦æ›¿æ¢çš„æ¨¡å—</h4>
  <p>é€šè¿‡<code>hotUpdate</code>å¯ä»¥æ‰¾åˆ°æ—§æ¨¡å—</p>
  <pre><code class="hljs javaScript copyable hljs language-cpp" lang="cpp">var queue = outdatedModules.<span class="hljs-built_in">slice</span>();
<span class="hljs-keyword">while</span> (queue.length &gt; <span class="hljs-number">0</span>) {
    moduleId = queue.<span class="hljs-built_in">pop</span>();
    <span class="hljs-comment">// ä»ç¼“å­˜ä¸­åˆ é™¤è¿‡æœŸçš„æ¨¡å—</span>
    <span class="hljs-keyword">module</span> = installedModules[moduleId];
    <span class="hljs-comment">// åˆ é™¤è¿‡æœŸçš„ä¾èµ–</span>
    <span class="hljs-keyword">delete</span> outdatedDependencies[moduleId];

    <span class="hljs-comment">// å­˜å‚¨äº†è¢«åˆ æ‰çš„æ¨¡å—idï¼Œä¾¿äºæ›´æ–°ä»£ç </span>
    outdatedSelfAcceptedModules.<span class="hljs-built_in">push</span>({
        <span class="hljs-keyword">module</span>: moduleId
    });
}<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><h4 class="heading" data-id="heading-12">â‘¡å°†æ–°çš„æ¨¡å—æ·»åŠ åˆ° modules ä¸­</h4>
  <pre><code class="hljs javaScript copyable hljs language-inform7" lang="inform7">appliedUpdate<span class="hljs-comment">[moduleId]</span> = hotUpdate<span class="hljs-comment">[moduleId]</span>;
for (moduleId in appliedUpdate) {
    if (Object.prototype.hasOwnProperty.call(appliedUpdate, moduleId)) {
        modules<span class="hljs-comment">[moduleId]</span> = appliedUpdate<span class="hljs-comment">[moduleId]</span>;
    }
}<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><h4 class="heading" data-id="heading-13">â‘¢é€šè¿‡__webpack_require__æ‰§è¡Œç›¸å…³æ¨¡å—çš„ä»£ç </h4>
  <pre><code class="hljs javaScript copyable hljs language-abnf" lang="abnf">for (i <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; outdatedSelfAcceptedModules.length; i++) {</span>
    var item <span class="hljs-operator">=</span> outdatedSelfAcceptedModules[i]<span class="hljs-comment">;</span>
    moduleId <span class="hljs-operator">=</span> item.module<span class="hljs-comment">;</span>
    try {
        // æ‰§è¡Œæœ€æ–°çš„ä»£ç 
        __webpack_require__(moduleId)<span class="hljs-comment">;</span>
    } catch (err) {
        // ...å®¹é”™å¤„ç†
    }
}
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre><p><code>hotApply</code>çš„ç¡®æ¯”è¾ƒå¤æ‚ï¼ŒçŸ¥é“å¤§æ¦‚æµç¨‹å°±å¥½äº†ï¼Œè¿™ä¸€å°èŠ‚ï¼Œè¦æ±‚ä½ å¯¹webpackæ‰“åŒ…åçš„æ–‡ä»¶å¦‚ä½•æ‰§è¡Œçš„æœ‰ä¸€äº›äº†è§£ï¼Œå¤§å®¶å¯ä»¥è‡ªå»çœ‹ä¸‹ã€‚</p>
  <h2 class="heading" data-id="heading-14">å››ã€æ€»ç»“</h2>
  <p>è¿˜æ˜¯ä»¥é˜…è¯»æºç çš„å½¢å¼ç”»çš„å›¾ï¼Œâ‘ -â‘£çš„å°æ ‡è®°ï¼Œæ˜¯æ–‡ä»¶å‘ç”Ÿå˜åŒ–çš„ä¸€ä¸ªæµç¨‹ã€‚
  </p><figure><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ec13499800dfce~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" loading="lazy" class="medium-zoom-image"><figcaption></figcaption></figure><p></p>
  <h2 class="heading" data-id="heading-15">å†™åœ¨æœ€å</h2>
  <p>æœ¬æ¬¡æ˜¯ä»¥é˜…è¯»æºç çš„æ–¹å¼è®²è§£åŸç†ï¼Œæ˜¯å› ä¸ºè§‰å¾—çƒ­æ›´æ–°è¿™å—æ¶‰åŠçš„çŸ¥è¯†é‡æ¯”è¾ƒå¤šã€‚æ‰€ä»¥çŸ¥è¯†æŠŠå…³é”®æ€§ä»£ç æ‹¿å‡ºæ¥ï¼Œå› ä¸ºæ¯ä¸€ä¸ªå—ç»†èŠ‚è¯´èµ·æ¥éƒ½èƒ½å†™ä¸€ç¯‡æ–‡ç« äº†ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å¯¹ç€æºç å†ç†è§£ä¸‹ã€‚</p>
  <p>è¿˜æ˜¯å»ºè®®æå‰äº†è§£ä»¥ä¸‹çŸ¥è¯†ä¼šæ›´å¥½ç†è§£çƒ­æ›´æ–°ï¼š</p>
  <ul>
    <li><strong>websocket</strong>ï¼š<a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2017%2F05%2Fwebsocket.html" title="https://www.ruanyifeng.com/blog/2017/05/websocket.html" ref="nofollow noopener noreferrer">websocketåŸºç¡€çŸ¥è¯†äº†è§£</a></li>
    <li>æ‰“åŒ…åçš„<code>bundle</code>æ–‡ä»¶å¦‚ä½•è¿è¡Œçš„ã€‚</li>
    <li><code>webpack</code>å¯åŠ¨æµç¨‹ï¼Œ<code>webpack</code>ç”Ÿå‘½å‘¨æœŸã€‚</li>
    <li><strong>tapable</strong>: <a target="_blank" href="https://juejin.cn/post/6844904004435050503" title="https://juejin.cn/post/6844904004435050503">Webpackæ’ä»¶æœºåˆ¶ä¹‹Tapable-æºç è§£æ</a></li>
  </ul>
  <h2 class="heading" data-id="heading-16">å‚è€ƒé“¾æ¥</h2>
  <ul>
    <li><a target="_blank" href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJocs%2Fjocs.github.io%2Fissues%2F15" title="https://github.com/Jocs/jocs.github.io/issues/15" ref="nofollow noopener noreferrer">Webpack Hot Module Replacement çš„åŸç†è§£æ</a></li>
    <li><a target="_blank" href="https://juejin.cn/post/6844903953092591630" title="https://juejin.cn/post/6844903953092591630">çœ‹å®Œè¿™ç¯‡ï¼Œé¢è¯•å†ä¹Ÿä¸æ€•è¢«é—® Webpack çƒ­æ›´æ–°</a></li>
  </ul>
  <p>å‚è€ƒçš„æ–‡ç« å¤§å®¶ä¹Ÿå¯ä»¥çœ‹ä¸‹ï¼Œä½†æ˜¯ç”±äºæºç ç‰ˆæœ¬ä¸åŒï¼Œæ‰€ä»¥ä¸è¦å¤ªçº ç»“ä¸ç»†èŠ‚ã€‚</p>
  <p>åŸåˆ›ä¸æ˜“ï¼Œèµ°è¿‡è·¯è¿‡ç‚¹ä¸ªèµå§~ğŸ˜Š</p>
</div>
