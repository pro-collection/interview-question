> 2023.03.09 - 2023.03.15 æ›´æ–°æ”¶é›†é¢è¯•é—®é¢˜ï¼ˆ45é“é¢˜ï¼‰ã€ç¬¬3éƒ¨åˆ†ã€‘           
è·å–æ›´å¤šé¢è¯•é—®é¢˜å¯ä»¥è®¿é—®            
github åœ°å€: https://github.com/pro-collection/interview-question/issues            
gitee åœ°å€: https://gitee.com/yanleweb/interview-question/issues          



ç›®å½•ï¼š






- é«˜çº§å¼€å‘è€…ç›¸å…³é—®é¢˜ã€å…±è®¡ 1 é“é¢˜ã€‘
  - 77.è™šæ‹Ÿ dom åŸç†æ˜¯å•¥ï¼Œæ‰‹å†™ä¸€ä¸ªç®€ç­”çš„è™šæ‹Ÿ dom å®ç°ï¼Ÿã€JavaScriptã€‘


- èµ„æ·±å¼€å‘è€…ç›¸å…³é—®é¢˜ã€å…±è®¡ 4 é“é¢˜ã€‘
  - 76.JS å†…å­˜æ³„éœ²é—®é¢˜è¯¥å¦‚ä½•æ’æŸ¥ï¼Ÿã€JavaScriptã€‘
  - 78.[vue]: vue2.x è™šæ‹Ÿ dom æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿã€webæ¡†æ¶ã€‘
  - 79.[vue]: æ˜¯å¦‚ä½•å®ç° MVVM çš„ï¼Ÿã€webæ¡†æ¶ã€‘
  - 80.[Redux]: çœ‹è¿‡ Redux æºç å—ï¼Œ å¯¹ Redux äº†è§£å¤šå°‘ï¼Ÿã€webæ¡†æ¶ã€‘




    








# é«˜çº§å¼€å‘è€…ç›¸å…³é—®é¢˜ã€å…±è®¡ 1 é“é¢˜ã€‘

## 77.è™šæ‹Ÿ dom åŸç†æ˜¯å•¥ï¼Œæ‰‹å†™ä¸€ä¸ªç®€ç­”çš„è™šæ‹Ÿ dom å®ç°ï¼Ÿã€JavaScriptã€‘
      


## vdom æ¦‚å¿µ
ç”¨JSæ¨¡æ‹ŸDOMç»“æ„ã€‚             
DOMå˜åŒ–çš„å¯¹æ¯”ï¼Œæ”¾åœ¨JSå±‚æ¥åšã€‚               
æå‡é‡ç»˜æ€§èƒ½ã€‚

æ¯”å¦‚æœ‰abc ä¸‰ä¸ªdomï¼Œ å¦‚æœæˆ‘ä»¬è¦åˆ é™¤b dom, ä»¥å‰æµè§ˆå™¨çš„åšæ³•æ˜¯ å…¨éƒ¨åˆ é™¤abc dom ï¼Œ ç„¶å åœ¨æ·»åŠ b dom ã€‚è¿™æ ·åšçš„æˆæœ¬ä¼šéå¸¸é«˜ã€‚

## ç”¨JSæ¨¡æ‹Ÿ dom
ä¾‹å¦‚ä¸‹é¢çš„ä¸€ä¸ªdom ç»“æ„ï¼š
```html
<ul id="list">
    <li class="item">item1</li>
    <li class="item">item2</li>
</ul>
```

è¿™æ ·çš„dom ç»“æ„ï¼Œå¯ä»¥æ¨¡æ‹Ÿä¸ºä¸‹é¢çš„JS :
```javascript
let dom = {
    tag: 'ul',
    attrs: {
        id: 'list'
    },
    children: [
        {
            tag: 'li',
            attrs: {className: 'item'},
            children: ['item1']
        },
        {
            tag: 'li',
            attrs: {className: 'item'},
            children: ['item2']
        }
    ]
}
```
æµè§ˆå™¨æ“ä½œdom æ˜¯èŠ±é”€éå¸¸å¤§çš„ã€‚æ‰§è¡ŒJSèŠ±é”€è¦å°éå¸¸å¤šï¼Œæ‰€ä»¥è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè™šæ‹Ÿdom å‡ºç°çš„ä¸€ä¸ªæ ¹æœ¬åŸå› ã€‚

## jqueryå®ç°virtual-dom

### ä¸€ä¸ªéœ€æ±‚åœºæ™¯
1ã€æ•°æ®ç”Ÿæˆè¡¨æ ¼ã€‚ 2ã€éšä¾¿ä¿®æ”¹ä¸€ä¸ªä¿¡æ¯ï¼Œè¡¨æ ¼ä¹Ÿä¼šè·Ÿç€ä¿®æ”¹ã€‚
```html
<body>
<div id="container"></div>
<br>
<button id="btn-change">change</button>
<script>
    let data = [
        {
            name: 'yanle',
            age: '20',
            address: 'é‡åº†'
        },
        {
            name: 'yanle2',
            age: '25',
            address: 'æˆéƒ½'
        },
        {
            name: 'yanle3',
            age: '27',
            address: 'æ·±åœ³'
        }
    ];

    // æ¸²æŸ“å‡½æ•°
    function render(data) {
        let $container = document.getElementById('container');
        $container.innerHTML = '';

        let $table = document.createElement('table');
        $table.setAttribute('border', true);
        $table.insertAdjacentHTML('beforeEnd', `<tr>
                                    <td>name</td>
                                    <td>age</td>
                                    <td>address</td>
                                    </tr>`);

        data.forEach(function (item) {
            $table.insertAdjacentHTML('beforeEnd',
                `<tr>
                    <td>${item.name}</td>
                    <td>${item.age}</td>
                    <td>${item.address}</td>
                </tr>`
            )
        });

        $container.appendChild($table);
    }

    // ä¿®æ”¹ä¿¡æ¯
    let button = document.getElementById('btn-change');
    button.addEventListener('click', function () {
        data[1].name = 'å¾è€æ¯•';
        data[1].age = 30;
        data[1].address  = 'æ·±åœ³';
        render(data);
    });
    render(data);
</script>
</body>
```
å®é™…ä¸Šä¸Šé¢çš„è¿™æ®µä»£ç ä¹Ÿæ˜¯ä¸ç¬¦åˆé¢„æœŸçš„ï¼Œå› ä¸ºæ¯æ¬¡ä½¿ç”¨render æ–¹æ³•ï¼Œéƒ½ä¼šå…¨éƒ¨æ¸²æŸ“æ•´ä¸ªtable, ä½†æ˜¯å¹¶æœªæ²¡æœ‰åªæ¸²æŸ“æˆ‘ä»¬æƒ³è¦çš„ç¬¬äºŒè¡Œã€‚

**é‡åˆ°çš„é—®é¢˜**ï¼š                  
DOM æ“ä½œæ˜¯éå¸¸ "æ˜‚è´µ" çš„ï¼Œ JS è¿è¡Œæ•ˆç‡é«˜ã€‚è™šæ‹Ÿdom çš„æ ¸å¿ƒå°±æ˜¯diffç®—æ³•ï¼Œå¯¹æ¯”å‡ºä¸åŒçš„domæ•°æ®ï¼Œå®šç‚¹æ¸²æŸ“ä¸åŒçš„æ•°æ®ã€‚

           



# èµ„æ·±å¼€å‘è€…ç›¸å…³é—®é¢˜ã€å…±è®¡ 4 é“é¢˜ã€‘

## 76.JS å†…å­˜æ³„éœ²é—®é¢˜è¯¥å¦‚ä½•æ’æŸ¥ï¼Ÿã€JavaScriptã€‘
      
## ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²

> è¯¥é—®é¢˜è½¬è½½è‡ªï¼šhttps://github.com/zhansingsong/js-leakage-patterns

> **å†…å­˜æ³„æ¼**æŒ‡ç”±äºç–å¿½æˆ–é”™è¯¯é€ æˆç¨‹åºæœªèƒ½é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚å†…å­˜æ³„æ¼å¹¶éæŒ‡å†…å­˜åœ¨ç‰©ç†ä¸Šçš„æ¶ˆå¤±ï¼Œè€Œæ˜¯åº”ç”¨ç¨‹åºåˆ†é…æŸæ®µå†…å­˜åï¼Œç”±äºè®¾è®¡é”™è¯¯ï¼Œå¯¼è‡´åœ¨é‡Šæ”¾è¯¥æ®µå†…å­˜ä¹‹å‰å°±å¤±å»äº†å¯¹è¯¥æ®µå†…å­˜çš„æ§åˆ¶ï¼Œä»è€Œé€ æˆäº†å†…å­˜çš„æµªè´¹ã€‚å†…å­˜æ³„æ¼é€šå¸¸æƒ…å†µä¸‹åªèƒ½ç”±è·å¾—ç¨‹åºæºä»£ç çš„ç¨‹åºå‘˜æ‰èƒ½åˆ†æå‡ºæ¥ã€‚ç„¶è€Œï¼Œæœ‰ä¸å°‘äººä¹ æƒ¯äºæŠŠä»»ä½•ä¸éœ€è¦çš„å†…å­˜ä½¿ç”¨çš„å¢åŠ æè¿°ä¸ºå†…å­˜æ³„æ¼ï¼Œå³ä½¿ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´è¿™æ˜¯ä¸å‡†ç¡®çš„ã€‚
> â€”â€”â€”â€”[wikipedia](https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F)

**âš ï¸ æ³¨ï¼šä¸‹æ–‡ä¸­æ ‡æ³¨çš„ CG æ˜¯ Chrome æµè§ˆå™¨ä¸­ Devtools çš„ã€Collect garbageã€‘æŒ‰é’®ç¼©å†™ï¼Œè¡¨ç¤ºå›æ”¶åƒåœ¾æ“ä½œã€‚**
![image](https://user-images.githubusercontent.com/22188674/224474179-30705fda-6d94-41b9-9979-053914e02da5.png)

## æ„å¤–çš„å…¨å±€å˜é‡

JavaScript å¯¹æœªå£°æ˜å˜é‡çš„å¤„ç†æ–¹å¼ï¼šåœ¨å…¨å±€å¯¹è±¡ä¸Šåˆ›å»ºè¯¥å˜é‡çš„å¼•ç”¨(å³å…¨å±€å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œä¸æ˜¯å˜é‡ï¼Œå› ä¸ºå®ƒèƒ½é€šè¿‡`delete`åˆ é™¤)ã€‚å¦‚æœåœ¨æµè§ˆå™¨ä¸­ï¼Œå…¨å±€å¯¹è±¡å°±æ˜¯**window**å¯¹è±¡ã€‚

å¦‚æœæœªå£°æ˜çš„å˜é‡ç¼“å­˜å¤§é‡çš„æ•°æ®ï¼Œä¼šå¯¼è‡´è¿™äº›æ•°æ®åªæœ‰åœ¨çª—å£å…³é—­æˆ–é‡æ–°åˆ·æ–°é¡µé¢æ—¶æ‰èƒ½è¢«é‡Šæ”¾ã€‚è¿™æ ·ä¼šé€ æˆæ„å¤–çš„å†…å­˜æ³„æ¼ã€‚

```js
function foo(arg) {
  bar = 'this is a hidden global variable with a large of data';
}
```

ç­‰åŒäºï¼š

```js
function foo(arg) {
  window.bar = 'this is an explicit global variable with a large of data';
}
```

å¦å¤–ï¼Œé€šè¿‡**this**åˆ›å»ºæ„å¤–çš„å…¨å±€å˜é‡ï¼š

```js
function foo() {
  this.variable = 'potential accidental global';
}

// å½“åœ¨å…¨å±€ä½œç”¨åŸŸä¸­è°ƒç”¨fooå‡½æ•°ï¼Œæ­¤æ—¶thisæŒ‡å‘çš„æ˜¯å…¨å±€å¯¹è±¡(window)ï¼Œè€Œä¸æ˜¯'undefined'
foo();
```

### è§£å†³æ–¹æ³•ï¼š

åœ¨ JavaScript æ–‡ä»¶ä¸­æ·»åŠ `'use strict'`ï¼Œå¼€å¯ä¸¥æ ¼æ¨¡å¼ï¼Œå¯ä»¥æœ‰æ•ˆåœ°é¿å…ä¸Šè¿°é—®é¢˜ã€‚

```js
function foo(arg) {
  'use strict'; // åœ¨fooå‡½æ•°ä½œç”¨åŸŸå†…å¼€å¯ä¸¥æ ¼æ¨¡å¼
  bar = 'this is an explicit global variable with a large of data'; // æŠ¥é”™ï¼šå› ä¸ºbarè¿˜æ²¡æœ‰è¢«å£°æ˜
}
```

å¦‚æœéœ€è¦åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ä½¿ç”¨å…¨å±€å˜é‡ï¼Œå¯ä»¥åƒå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œåœ¨**window**ä¸Šæ˜ç¡®å£°æ˜ï¼š

```js
function foo(arg) {
  window.bar = 'this is a explicit global variable with a large of data';
}
```

è¿™æ ·ä¸ä»…å¯è¯»æ€§é«˜ï¼Œè€Œä¸”åæœŸç»´æŠ¤ä¹Ÿæ–¹ä¾¿

> è°ˆåˆ°å…¨å±€å˜é‡ï¼Œéœ€è¦æ³¨æ„é‚£äº›ç”¨æ¥ä¸´æ—¶å­˜å‚¨å¤§é‡æ•°æ®çš„å…¨å±€å˜é‡ï¼Œç¡®ä¿åœ¨å¤„ç†å®Œè¿™äº›æ•°æ®åå°†å…¶è®¾ç½®ä¸º null æˆ–é‡æ–°èµ‹å€¼ã€‚å…¨å±€å˜é‡ä¹Ÿå¸¸ç”¨æ¥åš cacheï¼Œä¸€èˆ¬ cache éƒ½æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–æ‰ç”¨åˆ°çš„ï¼Œä¸ºäº†æ€§èƒ½ï¼Œæœ€å¥½å¯¹ cache çš„å¤§å°åšä¸ªä¸Šé™é™åˆ¶ã€‚å› ä¸º cache æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ï¼Œè¶Šé«˜ cache ä¼šå¯¼è‡´è¶Šé«˜çš„å†…å­˜æ¶ˆè€—ã€‚

## console.log

`console.log`ï¼šå‘ web å¼€å‘æ§åˆ¶å°æ‰“å°ä¸€æ¡æ¶ˆæ¯ï¼Œå¸¸ç”¨æ¥åœ¨å¼€å‘æ—¶è°ƒè¯•åˆ†æã€‚æœ‰æ—¶åœ¨å¼€å‘æ—¶ï¼Œéœ€è¦æ‰“å°ä¸€äº›å¯¹è±¡ä¿¡æ¯ï¼Œä½†å‘å¸ƒæ—¶å´å¿˜è®°å»æ‰`console.log`è¯­å¥ï¼Œè¿™å¯èƒ½é€ æˆå†…å­˜æ³„éœ²ã€‚

åœ¨ä¼ é€’ç»™`console.log`çš„å¯¹è±¡æ˜¯ä¸èƒ½è¢«åƒåœ¾å›æ”¶ â™»ï¸ï¼Œå› ä¸ºåœ¨ä»£ç è¿è¡Œä¹‹åéœ€è¦åœ¨å¼€å‘å·¥å…·èƒ½æŸ¥çœ‹å¯¹è±¡ä¿¡æ¯ã€‚æ‰€ä»¥æœ€å¥½ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­`console.log`ä»»ä½•å¯¹è±¡ã€‚

### å®ä¾‹

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Leaker</title>
</head>

<body>
  <input type="button" value="click">
  <script>
    !function () {
      function Leaker() {
        this.init();
      };
      Leaker.prototype = {
        init: function () {
          this.name = (Array(100000)).join('*');
          console.log("Leaking an object %o: %o", (new Date()), this);// thiså¯¹è±¡ä¸èƒ½è¢«å›æ”¶
        },

        destroy: function () {
          // do something....
        }
      };
      document.querySelector('input').addEventListener('click', function () {
        new Leaker();
      }, false);
    }()
  </script>
</body>

</html>
```

è¿™é‡Œç»“åˆ Chrome çš„ Devtoolsâ€“>Performance åšä¸€äº›åˆ†æï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

<u>**:warning:æ³¨ï¼šæœ€å¥½åœ¨éšè—çª—å£ä¸­è¿›è¡Œåˆ†æå·¥ä½œï¼Œé¿å…æµè§ˆå™¨æ’ä»¶å½±å“åˆ†æç»“æœ**</u>

1.  å¼€å¯ã€Performanceã€‘é¡¹çš„è®°å½•
2.  æ‰§è¡Œä¸€æ¬¡ CGï¼Œåˆ›å»ºåŸºå‡†å‚è€ƒçº¿
3.  è¿ç»­å•å‡»ã€clickã€‘æŒ‰é’®ä¸‰æ¬¡ï¼Œæ–°å»ºä¸‰ä¸ª Leaker å¯¹è±¡
4.  æ‰§è¡Œä¸€æ¬¡ CG
5.  åœæ­¢è®°å½•

![image](https://user-images.githubusercontent.com/22188674/224474228-13446f61-b837-4ede-88a7-38227d8ab9c5.png)

å¯ä»¥çœ‹å‡ºã€JS Heapã€‘çº¿æœ€åæ²¡æœ‰é™å›åˆ°åŸºå‡†å‚è€ƒçº¿çš„ä½ç½®ï¼Œæ˜¾ç„¶å­˜åœ¨æ²¡æœ‰è¢«å›æ”¶çš„å†…å­˜ã€‚å¦‚æœå°†ä»£ç ä¿®æ”¹ä¸ºï¼š

```js
!(function() {
  function Leaker() {
    this.init();
  }
  Leaker.prototype = {
    init: function() {
      this.name = Array(100000).join('*');
    },

    destroy: function() {
      // do something....
    },
  };
  document.querySelector('input').addEventListener(
    'click',
    function() {
      new Leaker();
    },
    false,
  );
})();
```

å»æ‰`console.log("Leaking an object %o: %o", (new Date()), this);`è¯­å¥ã€‚é‡å¤ä¸Šè¿°çš„æ“ä½œæ­¥éª¤ï¼Œåˆ†æç»“æœå¦‚ä¸‹ï¼š

![image](https://user-images.githubusercontent.com/22188674/224474259-46b22d10-0314-4664-adc1-fdef2a575c19.png)

ä»å¯¹æ¯”åˆ†æç»“æœå¯çŸ¥ï¼Œ`console.log`æ‰“å°çš„å¯¹è±¡æ˜¯ä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶çš„ã€‚å› æ­¤æœ€å¥½ä¸è¦åœ¨é¡µé¢ä¸­`console.log`ä»»ä½•å¤§å¯¹è±¡ï¼Œè¿™æ ·å¯èƒ½ä¼šå½±å“é¡µé¢çš„æ•´ä½“æ€§èƒ½ï¼Œç‰¹åˆ«åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ã€‚é™¤äº†`console.log`å¤–ï¼Œå¦å¤–è¿˜æœ‰`console.dir`ã€`console.error`ã€`console.warn`ç­‰éƒ½å­˜åœ¨ç±»ä¼¼çš„é—®é¢˜ï¼Œè¿™äº›ç»†èŠ‚éœ€è¦ç‰¹åˆ«çš„å…³æ³¨ã€‚

## closures(é—­åŒ…)

å½“ä¸€ä¸ªå‡½æ•° A è¿”å›ä¸€ä¸ªå†…è”å‡½æ•° Bï¼Œå³ä½¿å‡½æ•° A æ‰§è¡Œå®Œï¼Œå‡½æ•° B ä¹Ÿèƒ½è®¿é—®å‡½æ•° A ä½œç”¨åŸŸå†…çš„å˜é‡ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªé—­åŒ…â€”â€”â€”â€”â€”â€”æœ¬è´¨ä¸Šé—­åŒ…æ˜¯å°†å‡½æ•°å†…éƒ¨å’Œå¤–éƒ¨è¿æ¥èµ·æ¥çš„ä¸€åº§æ¡¥æ¢ã€‚

```js
function foo(message) {
  function closure() {
    console.log(message);
  }
  return closure;
}

// ä½¿ç”¨
var bar = foo('hello closure!');
bar(); // è¿”å› 'hello closure!'
```

åœ¨å‡½æ•° foo å†…åˆ›å»ºçš„å‡½æ•° closure å¯¹è±¡æ˜¯ä¸èƒ½è¢«å›æ”¶æ‰çš„ï¼Œå› ä¸ºå®ƒè¢«å…¨å±€å˜é‡ bar å¼•ç”¨ï¼Œå¤„äºä¸€ç›´å¯è®¿é—®çŠ¶æ€ã€‚é€šè¿‡æ‰§è¡Œ`bar()`å¯ä»¥æ‰“å°å‡º`hello closure!`ã€‚å¦‚æœæƒ³é‡Šæ”¾æ‰å¯ä»¥å°†`bar = null`å³å¯ã€‚

<u>**ç”±äºé—­åŒ…ä¼šæºå¸¦åŒ…å«å®ƒçš„å‡½æ•°çš„ä½œç”¨åŸŸï¼Œå› æ­¤ä¼šæ¯”å…¶ä»–å‡½æ•°å ç”¨æ›´å¤šçš„å†…å­˜ã€‚è¿‡åº¦ä½¿ç”¨é—­åŒ…å¯èƒ½ä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡å¤šã€‚**</u>

### å®ä¾‹

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Closure</title>
</head>

<body>
  <p>ä¸æ–­å•å‡»ã€clickã€‘æŒ‰é’®</p>
  <button id="click_button">Click</button>
  <script>
    function f() {
      var str = Array(10000).join('#');
      var foo = {
        name: 'foo'
      }
      function unused() {
        var message = 'it is only a test message';
        str = 'unused: ' + str;
      }
      function getData() {
        return 'data';
      }
      return getData;
    }

    var list = [];

    document.querySelector('#click_button').addEventListener('click', function () {
      list.push(f());
    }, false);
  </script>
</body>

</html>
```

è¿™é‡Œç»“åˆ Chrome çš„ Devtools->Memory å·¥å…·è¿›è¡Œåˆ†æï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

<u>**:warning:æ³¨ï¼šæœ€å¥½åœ¨éšè—çª—å£ä¸­è¿›è¡Œåˆ†æå·¥ä½œï¼Œé¿å…æµè§ˆå™¨æ’ä»¶å½±å“åˆ†æç»“æœ**</u>

1.  é€‰ä¸­ã€Record allocation timelineã€‘é€‰é¡¹
2.  æ‰§è¡Œä¸€æ¬¡ CG
3.  å•å‡»ã€startã€‘æŒ‰é’®å¼€å§‹è®°å½•å †åˆ†æ
4.  è¿ç»­å•å‡»ã€clickã€‘æŒ‰é’®åå¤šæ¬¡
5.  åœæ­¢è®°å½•å †åˆ†æ

![image](https://user-images.githubusercontent.com/22188674/224474271-188cb4f6-a00d-4a29-98ab-10e02818b93d.png)

ä¸Šå›¾ä¸­è“è‰²æŸ±å½¢æ¡è¡¨ç¤ºéšç€æ—¶é—´æ–°åˆ†é…çš„å†…å­˜ã€‚é€‰ä¸­å…¶ä¸­æŸæ¡è“è‰²æŸ±å½¢æ¡ï¼Œè¿‡æ»¤å‡ºå¯¹åº”æ–°åˆ†é…çš„å¯¹è±¡ï¼š

![image](https://user-images.githubusercontent.com/22188674/224474296-a78617eb-17e6-4964-a1e5-2f9a08650872.png)

æŸ¥çœ‹å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ï¼š

![image](https://user-images.githubusercontent.com/22188674/224474311-fca18dc0-7ce8-410f-a573-55cbd32ee07f.png)

ä»å›¾å¯çŸ¥ï¼Œåœ¨è¿”å›çš„é—­åŒ…ä½œç”¨é“¾(Scopes)ä¸­æºå¸¦æœ‰å®ƒæ‰€åœ¨å‡½æ•°çš„ä½œç”¨åŸŸï¼Œä½œç”¨åŸŸä¸­è¿˜åŒ…å«ä¸€ä¸ª str å­—æ®µã€‚è€Œ str å­—æ®µå¹¶æ²¡æœ‰åœ¨è¿”å› getData()ä¸­ä½¿ç”¨è¿‡ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨åœ¨ä½œç”¨åŸŸä¸­ï¼ŒæŒ‰ç†åº”è¯¥è¢« GC å›æ”¶æ‰ï¼Œ why:question:

åŸå› æ˜¯åœ¨ç›¸åŒä½œç”¨åŸŸå†…åˆ›å»ºçš„å¤šä¸ªå†…éƒ¨å‡½æ•°å¯¹è±¡æ˜¯å…±äº«åŒä¸€ä¸ª[å˜é‡å¯¹è±¡ï¼ˆvariable objectï¼‰](http://dmitrysoshnikov.com/ecmascript/chapter-2-variable-object/)ã€‚å¦‚æœåˆ›å»ºçš„å†…éƒ¨å‡½æ•°æ²¡æœ‰è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œä¸ç®¡å†…éƒ¨å‡½æ•°æ˜¯å¦å¼•ç”¨å¤–éƒ¨å‡½æ•°çš„å˜é‡å’Œå‡½æ•°ï¼Œåœ¨å¤–éƒ¨å‡½æ•°æ‰§è¡Œå®Œï¼Œå¯¹åº”å˜é‡å¯¹è±¡ä¾¿ä¼šè¢«é”€æ¯ã€‚åä¹‹ï¼Œå¦‚æœå†…éƒ¨å‡½æ•°ä¸­å­˜åœ¨æœ‰å¯¹å¤–éƒ¨å‡½æ•°å˜é‡æˆ–å‡½æ•°çš„è®¿é—®ï¼ˆå¯ä»¥ä¸æ˜¯è¢«å¼•ç”¨çš„å†…éƒ¨å‡½æ•°ï¼‰ï¼Œå¹¶ä¸”å­˜åœ¨æŸä¸ªæˆ–å¤šä¸ªå†…éƒ¨å‡½æ•°è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šå½¢æˆé—­åŒ…ï¼Œå¤–éƒ¨å‡½æ•°çš„å˜é‡å¯¹è±¡å°±ä¼šå­˜åœ¨äºé—­åŒ…å‡½æ•°çš„ä½œç”¨åŸŸé“¾ä¸­ã€‚è¿™æ ·ç¡®ä¿äº†é—­åŒ…å‡½æ•°æœ‰æƒè®¿é—®å¤–éƒ¨å‡½æ•°çš„æ‰€æœ‰å˜é‡å’Œå‡½æ•°ã€‚äº†è§£äº†é—®é¢˜äº§ç”Ÿçš„åŸå› ï¼Œä¾¿å¯ä»¥å¯¹ç—‡ä¸‹è¯äº†ã€‚å¯¹ä»£ç åšå¦‚ä¸‹ä¿®æ”¹ï¼š

```js
function f() {
  var str = Array(10000).join('#');
  var foo = {
    name: 'foo',
  };
  function unused() {
    var message = 'it is only a test message';
    // str = 'unused: ' + str; //åˆ é™¤è¯¥æ¡è¯­å¥
  }
  function getData() {
    return 'data';
  }
  return getData;
}

var list = [];

document.querySelector('#click_button').addEventListener(
  'click',
  function() {
    list.push(f());
  },
  false,
);
```

getData()å’Œ unused()å†…éƒ¨å‡½æ•°å…±äº« f å‡½æ•°å¯¹åº”çš„å˜é‡å¯¹è±¡ï¼Œå› ä¸º unused()å†…éƒ¨å‡½æ•°è®¿é—®äº† f ä½œç”¨åŸŸå†… str å˜é‡ï¼Œæ‰€ä»¥ str å­—æ®µå­˜åœ¨äº f å˜é‡å¯¹è±¡ä¸­ã€‚åŠ ä¸Š getData()å†…éƒ¨å‡½æ•°è¢«è¿”å›ï¼Œè¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œå½¢æˆäº†é—­åŒ…ï¼Œå› æ­¤å¯¹åº”çš„ f å˜é‡å¯¹è±¡å­˜åœ¨äºé—­åŒ…å‡½æ•°çš„ä½œç”¨åŸŸé“¾ä¸­ã€‚è¿™é‡Œåªè¦å°†å‡½æ•° unused ä¸­`str = 'unused: ' + str;`è¯­å¥åˆ é™¤ä¾¿å¯è§£å†³é—®é¢˜ã€‚

![image](https://user-images.githubusercontent.com/22188674/224474321-74c7546e-4e2a-4d06-b32d-b25ac5f4235b.png)

æŸ¥çœ‹ä¸€ä¸‹é—­åŒ…ä¿¡æ¯ï¼š

![image](https://user-images.githubusercontent.com/22188674/224474341-9c7ec3b8-e3a1-40ad-9bcc-f570ca7d2bd6.png)

## DOM æ³„éœ²

åœ¨ JavaScript ä¸­ï¼ŒDOM æ“ä½œæ˜¯éå¸¸è€—æ—¶çš„ã€‚å› ä¸º JavaScript/ECMAScript å¼•æ“ç‹¬ç«‹äºæ¸²æŸ“å¼•æ“ï¼Œè€Œ DOM æ˜¯ä½äºæ¸²æŸ“å¼•æ“ï¼Œç›¸äº’è®¿é—®éœ€è¦æ¶ˆè€—ä¸€å®šçš„èµ„æºã€‚å¦‚ Chrome æµè§ˆå™¨ä¸­ DOM ä½äº WebCoreï¼Œè€Œ JavaScript/ECMAScript ä½äº V8 ä¸­ã€‚å‡å¦‚å°† JavaScript/ECMAScriptã€DOM åˆ†åˆ«æƒ³è±¡æˆä¸¤åº§å­¤å²›ï¼Œä¸¤å²›ä¹‹é—´é€šè¿‡ä¸€åº§æ”¶è´¹æ¡¥è¿æ¥ï¼Œè¿‡æ¡¥éœ€è¦äº¤çº³ä¸€å®šâ€œè¿‡æ¡¥è´¹â€ã€‚JavaScript/ECMAScript æ¯æ¬¡è®¿é—® DOM æ—¶ï¼Œéƒ½éœ€è¦äº¤çº³â€œè¿‡æ¡¥è´¹â€ã€‚å› æ­¤è®¿é—® DOM æ¬¡æ•°è¶Šå¤šï¼Œè´¹ç”¨è¶Šé«˜ï¼Œé¡µé¢æ€§èƒ½å°±ä¼šå—åˆ°å¾ˆå¤§å½±å“ã€‚[äº†è§£æ›´å¤š:information_source:](http://www.phpied.com/dom-access-optimization/)

![](http://www.phpied.com/wp-content/uploads/2009/12/domlandia.png)

ä¸ºäº†å‡å°‘ DOM è®¿é—®æ¬¡æ•°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“éœ€è¦å¤šæ¬¡è®¿é—®åŒä¸€ä¸ª DOM æ–¹æ³•æˆ–å±æ€§æ—¶ï¼Œä¼šå°† DOM å¼•ç”¨ç¼“å­˜åˆ°ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ã€‚<u>ä½†å¦‚æœåœ¨æ‰§è¡ŒæŸäº›åˆ é™¤ã€æ›´æ–°æ“ä½œåï¼Œå¯èƒ½ä¼šå¿˜è®°é‡Šæ”¾æ‰ä»£ç ä¸­å¯¹åº”çš„ DOM å¼•ç”¨ï¼Œè¿™æ ·ä¼šé€ æˆ DOM å†…å­˜æ³„éœ²ã€‚</u>

### å®ä¾‹------>

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Dom-Leakage</title>
</head>
<body>
  <input type="button" value="remove" class="remove" style="display:none;">
  <input type="button" value="add" class="add">

  <div class="container">
    <pre class="wrapper"></pre>
  </div>
  <script>
    // å› ä¸ºè¦å¤šæ¬¡ç”¨åˆ°pre.wrapperã€div.containerã€input.removeã€input.addèŠ‚ç‚¹ï¼Œå°†å…¶ç¼“å­˜åˆ°æœ¬åœ°å˜é‡ä¸­ï¼Œ
    var wrapper = document.querySelector('.wrapper');
    var container = document.querySelector('.container');
    var removeBtn = document.querySelector('.remove');
    var addBtn = document.querySelector('.add');
    var counter = 0;
    var once = true;
    // æ–¹æ³•
    var hide = function(target){
      target.style.display = 'none';
    }
    var show = function(target){
      target.style.display = 'inline-block';
    }
    // å›è°ƒå‡½æ•°
    var removeCallback = function(){
      removeBtn.removeEventListener('click', removeCallback, false);
      addBtn.removeEventListener('click', addCallback, false);
      hide(addBtn);
      hide(removeBtn);
      container.removeChild(wrapper);
    }
    var addCallback = function(){
      wrapper.appendChild(document.createTextNode('\t' + ++counter + 'ï¼ša new line text\n'));
      // æ˜¾ç¤ºåˆ é™¤æ“ä½œæŒ‰é’®
      if(once){
        show(removeBtn);
        once = false;
      }
    }
    // ç»‘å®šäº‹ä»¶
    removeBtn.addEventListener('click', removeCallback, false);
    addBtn.addEventListener('click', addCallback, false);
  </script>
</body>
</html>
```

è¿™é‡Œç»“åˆ Chrome æµè§ˆå™¨çš„ Devtoolsâ€“>Performance åšä¸€äº›åˆ†æï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

<u>**:warning:æ³¨ï¼šæœ€å¥½åœ¨éšè—çª—å£ä¸­è¿›è¡Œåˆ†æå·¥ä½œï¼Œé¿å…æµè§ˆå™¨æ’ä»¶å½±å“åˆ†æç»“æœ**</u>

1.  å¼€å¯ã€Performanceã€‘é¡¹çš„è®°å½•
2.  æ‰§è¡Œä¸€æ¬¡ CGï¼Œåˆ›å»ºåŸºå‡†å‚è€ƒçº¿
3.  è¿ç»­å•å‡»ã€addã€‘æŒ‰é’® 6 æ¬¡ï¼Œå¢åŠ  6 ä¸ªæ–‡æœ¬èŠ‚ç‚¹åˆ° pre å…ƒç´ ä¸­
4.  å•å‡»ã€removeã€‘æŒ‰é’®ï¼Œåˆ é™¤åˆšå¢åŠ  6 ä¸ªæ–‡æœ¬èŠ‚ç‚¹å’Œ pre å…ƒå…ƒç´ 
5.  æ‰§è¡Œä¸€æ¬¡ CG
6.  åœæ­¢è®°å½•å †åˆ†æ

![image](https://user-images.githubusercontent.com/22188674/224474368-2e72c152-76f6-4246-983a-bd4793eac45b.png)

ä»åˆ†æç»“æœå›¾å¯çŸ¥ï¼Œè™½ç„¶ 6 æ¬¡ add æ“ä½œå¢åŠ  6 ä¸ª Nodeï¼Œä½†æ˜¯ remove æ“ä½œå¹¶æ²¡æœ‰è®© Nodes èŠ‚ç‚¹æ•°ä¸‹é™ï¼Œå³ remove æ“ä½œå¤±è´¥ã€‚å°½ç®¡è¿˜ä¸»åŠ¨æ‰§è¡Œäº†ä¸€æ¬¡ CG æ“ä½œï¼ŒNodes æ›²çº¿ä¹Ÿæ²¡æœ‰ä¸‹é™ã€‚å› æ­¤å¯ä»¥æ–­å®šå†…å­˜æ³„éœ²äº†ï¼é‚£é—®é¢˜æ¥äº†ï¼Œå¦‚ä½•å»æŸ¥æ‰¾é—®é¢˜çš„åŸå› å‘¢ï¼Ÿè¿™é‡Œå¯ä»¥é€šè¿‡ Chrome æµè§ˆå™¨çš„ Devtoolsâ€“>Memory è¿›è¡Œè¯Šæ–­åˆ†æï¼Œæ‰§è¡Œå¦‚ä¸‹æ“ä½œæ­¥éª¤ï¼š

<u>**:warning:æ³¨ï¼šæœ€å¥½åœ¨éšè—çª—å£ä¸­è¿›è¡Œåˆ†æå·¥ä½œï¼Œé¿å…æµè§ˆå™¨æ’ä»¶å½±å“åˆ†æç»“æœ**</u>

1.  é€‰ä¸­ã€Take heap snapshotã€‘é€‰é¡¹
2.  è¿ç»­å•å‡»ã€addã€‘æŒ‰é’® 6 æ¬¡ï¼Œå¢åŠ  6 ä¸ªæ–‡æœ¬èŠ‚ç‚¹åˆ° pre å…ƒç´ ä¸­
3.  å•å‡»ã€Take snapshotã€‘æŒ‰é’®ï¼Œæ‰§è¡Œä¸€æ¬¡å †å¿«ç…§
4.  å•å‡»ã€removeã€‘æŒ‰é’®ï¼Œåˆ é™¤åˆšå¢åŠ  6 ä¸ªæ–‡æœ¬èŠ‚ç‚¹å’Œ pre å…ƒå…ƒç´ 
5.  å•å‡»ã€Take snapshotã€‘æŒ‰é’®ï¼Œæ‰§è¡Œä¸€æ¬¡å †å¿«ç…§
6.  é€‰ä¸­ç”Ÿæˆçš„ç¬¬äºŒä¸ªå¿«ç…§æŠ¥å‘Šï¼Œå¹¶å°†è§†å›¾ç”±"Summary"åˆ‡æ¢åˆ°"Comparison"å¯¹æ¯”æ¨¡å¼ï¼Œåœ¨[class filter]è¿‡æ»¤è¾“å…¥æ¡†ä¸­è¾“å…¥å…³é”®å­—ï¼š**Detached**

![image](https://user-images.githubusercontent.com/22188674/224474384-936ed2c1-3e5d-4e86-bb50-291b53500de0.png)

ä»åˆ†æç»“æœå›¾å¯çŸ¥ï¼Œå¯¼è‡´æ•´ä¸ª pre å…ƒç´ å’Œ 6 ä¸ªæ–‡æœ¬èŠ‚ç‚¹æ— æ³•åˆ«å›æ”¶çš„åŸå› æ˜¯ï¼šä»£ç ä¸­å­˜åœ¨å…¨å±€å˜é‡`wrapper`å¯¹ pre å…ƒç´ çš„å¼•ç”¨ã€‚çŸ¥é“äº†äº§ç”Ÿçš„é—®é¢˜åŸå› ï¼Œä¾¿å¯å¯¹ç—‡ä¸‹è¯äº†ã€‚å¯¹ä»£ç åšå¦‚ä¸‹å°±ä¿®æ”¹ï¼š

```js
// å› ä¸ºè¦å¤šæ¬¡ç”¨åˆ°pre.wrapperã€div.containerã€input.removeã€input.addèŠ‚ç‚¹ï¼Œå°†å…¶ç¼“å­˜åˆ°æœ¬åœ°å˜é‡ä¸­ï¼Œ
var wrapper = document.querySelector('.wrapper');
var container = document.querySelector('.container');
var removeBtn = document.querySelector('.remove');
var addBtn = document.querySelector('.add');
var counter = 0;
var once = true;
// æ–¹æ³•
var hide = function(target) {
  target.style.display = 'none';
};
var show = function(target) {
  target.style.display = 'inline-block';
};
// å›è°ƒå‡½æ•°
var removeCallback = function() {
  removeBtn.removeEventListener('click', removeCallback, false);
  addBtn.removeEventListener('click', addCallback, false);
  hide(addBtn);
  hide(removeBtn);
  container.removeChild(wrapper);

  wrapper = null; //åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼Œå°†wrapperå¯¹preèŠ‚ç‚¹çš„å¼•ç”¨é‡Šæ”¾æ‰
};
var addCallback = function() {
  wrapper.appendChild(
    document.createTextNode('\t' + ++counter + 'ï¼ša new line text\n'),
  );
  // æ˜¾ç¤ºåˆ é™¤æ“ä½œæŒ‰é’®
  if (once) {
    show(removeBtn);
    once = false;
  }
};
// ç»‘å®šäº‹ä»¶
removeBtn.addEventListener('click', removeCallback, false);
addBtn.addEventListener('click', addCallback, false);
```

åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼Œå°† wrapper å¯¹ pre èŠ‚ç‚¹çš„å¼•ç”¨é‡Šæ”¾æ‰ï¼Œå³åœ¨åˆ é™¤é€»è¾‘ä¸­å¢åŠ `wrapper = null;`è¯­å¥ã€‚å†æ¬¡åœ¨ Devtoolsâ€“>Performance ä¸­é‡å¤ä¸Šè¿°æ“ä½œï¼š

![image](https://user-images.githubusercontent.com/22188674/224474409-f5d310a6-8d94-40e8-be75-72250cf00da2.png)

### å°è¯•ç‰›åˆ€

å†æ¥çœ‹çœ‹ç½‘ä¸Šçš„ä¸€ä¸ªå®ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Practice</title>
</head>
<body>
  <div id="refA"><ul><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#" id="refB"></a></li></ul></div>
  <div></div>
  <div></div>

  <script>
    var refA = document.getElementById('refA');
    var refB = document.getElementById('refB');
    document.body.removeChild(refA);

    // #refAä¸èƒ½GCå›æ”¶ï¼Œå› ä¸ºå­˜åœ¨å˜é‡refAå¯¹å®ƒçš„å¼•ç”¨ã€‚å°†å…¶å¯¹#refAå¼•ç”¨é‡Šæ”¾ï¼Œä½†è¿˜æ˜¯æ— æ³•å›æ”¶#refAã€‚
    refA = null;

    // è¿˜å­˜åœ¨å˜é‡refBå¯¹#refAçš„é—´æ¥å¼•ç”¨(refBå¼•ç”¨äº†#refBï¼Œè€Œ#refBå±äº#refA)ã€‚å°†å˜é‡refBå¯¹#refBçš„å¼•ç”¨é‡Šæ”¾ï¼Œ#refAå°±å¯ä»¥è¢«GCå›æ”¶ã€‚
    refB = null;
  </script>
</body>
</html>
```

æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€æ¼”ç¤ºï¼š

![image](https://user-images.githubusercontent.com/22188674/224474442-b0ceefcf-a959-4cab-800c-df389737098b.png)

æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ä½¿ç”¨ Chrome çš„ Devtools å·¥å…·ï¼ŒéªŒè¯ä¸€ä¸‹åˆ†æç»“æœï¼Œå®è·µå¾ˆé‡è¦~~~:high_brightness:

## timers

åœ¨ JavaScript å¸¸ç”¨`setInterval()`æ¥å®ç°ä¸€äº›åŠ¨ç”»æ•ˆæœã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨é“¾å¼`setTimeout()`è°ƒç”¨æ¨¡å¼æ¥å®ç°ï¼š

```js
setTimeout(function() {
  // do something. . . .
  setTimeout(arguments.callee, interval);
}, interval);
```

å¦‚æœåœ¨ä¸éœ€è¦`setInterval()`æ—¶ï¼Œæ²¡æœ‰é€šè¿‡`clearInterval()`æ–¹æ³•ç§»é™¤ï¼Œé‚£ä¹ˆ`setInterval()`ä¼šä¸åœåœ°è°ƒç”¨å‡½æ•°ï¼Œç›´åˆ°è°ƒç”¨`clearInterval()`æˆ–çª—å£å…³é—­ã€‚å¦‚æœé“¾å¼`setTimeout()`è°ƒç”¨æ¨¡å¼æ²¡æœ‰ç»™å‡ºç»ˆæ­¢é€»è¾‘ï¼Œä¹Ÿä¼šä¸€ç›´è¿è¡Œä¸‹å»ã€‚å› æ­¤å†ä¸éœ€è¦é‡å¤å®šæ—¶å™¨æ—¶ï¼Œç¡®ä¿å¯¹å®šæ—¶å™¨è¿›è¡Œæ¸…é™¤ï¼Œé¿å…å ç”¨ç³»ç»Ÿèµ„æºã€‚å¦å¤–ï¼Œåœ¨ä½¿ç”¨`setInterval()`å’Œ`setTimeout()`æ¥å®ç°åŠ¨ç”»æ—¶ï¼Œæ— æ³•ç¡®ä¿å®šæ—¶å™¨æŒ‰ç…§æŒ‡å®šçš„æ—¶é—´é—´éš”æ¥æ‰§è¡ŒåŠ¨ç”»ã€‚ä¸ºäº†èƒ½åœ¨ JavaScript ä¸­åˆ›å»ºå‡ºå¹³æ»‘æµç•…çš„åŠ¨ç”»ï¼Œæµè§ˆå™¨ä¸º JavaScript åŠ¨ç”»æ·»åŠ äº†ä¸€ä¸ªæ–° API-requestAnimationFrame()ã€‚[å…³äº setIntervalã€setTimeout ä¸ requestAnimationFrame å®ç°åŠ¨ç”»ä¸Šçš„åŒºåˆ« â¹ çŒ›å‡» ğŸ˜Š](https://github.com/zhansingsong/js-leakage-patterns/blob/master/requestAnimationFrame/requestAnimationFrame.md)

### å®ä¾‹

å¦‚ä¸‹é€šè¿‡`setInterval()`å®ç°ä¸€ä¸ª clock çš„å°å®ä¾‹ï¼Œä¸è¿‡ä»£ç å­˜åœ¨é—®é¢˜çš„ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å…ˆå°è¯•æ‰¾ä¸€ä¸‹é—®é¢˜çš„æ‰€åœ¨~~~~~ğŸ˜
æ“ä½œï¼š

* å•å‡»ã€startã€‘æŒ‰é’®å¼€å§‹ clockï¼ŒåŒæ—¶ web å¼€å‘æ§åˆ¶å°ä¼šæ‰“å°å®æ—¶ä¿¡æ¯
* å•å‡»ã€stopã€‘æŒ‰é’®åœæ­¢ clockï¼ŒåŒæ—¶ web å¼€å‘æ§åˆ¶å°ä¼šè¾“å‡ºåœæ­¢ä¿¡æ¯

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>setInterval</title>
</head>
<body>
  <input type="button" value="start" class="start">
  <input type="button" value="stop" class="stop">

  <script>
    var counter = 0;
    var clock = {
      start: function () {
        setInterval(this.step.bind(null, ++counter), 1000);
      },
      step: function (flag) {
        var date = new Date();
        var h = date.getHours();
        var m = date.getMinutes();
        var s = date.getSeconds();
        console.log("%d-----> %d:%d:%d", flag, h, m, s);
      }
    }
    document.querySelector('.start').addEventListener('click', clock.start.bind(clock), false);
    document.querySelector('.stop').addEventListener('click', function () {
      console.log('----> stop <----');
      clock = null;
    }, false);
  </script>
</body>
</html>
```

ä¸Šè¿°ä»£ç å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

1.  å¦‚æœä¸æ–­çš„å•å‡»ã€startã€‘æŒ‰é’®ï¼Œä¼šæ–­ç”Ÿæˆæ–°çš„ clockã€‚

2.  å•å‡»ã€stopã€‘æŒ‰é’®ä¸èƒ½åœæ­¢ clockã€‚

è¾“å‡ºç»“æœ:

![image](https://user-images.githubusercontent.com/22188674/224474541-d2ad7c5a-d465-4167-b69d-c38c09930a67.png)

é’ˆå¯¹æš´éœ²å‡ºçš„é—®é¢˜ï¼Œå¯¹ä»£ç åšå¦‚ä¸‹ä¿®æ”¹ï¼š

```js
var counter = 0;
var clock = {
  timer: null,
  start: function() {
    // è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜
    if (this.timer) {
      clearInterval(this.timer);
    }
    this.timer = setInterval(this.step.bind(null, ++counter), 1000);
  },
  step: function(flag) {
    var date = new Date();
    var h = date.getHours();
    var m = date.getMinutes();
    var s = date.getSeconds();
    console.log('%d-----> %d:%d:%d', flag, h, m, s);
  },
  // è§£å†³ç¬¬äºŒä¸ªé—®é¢˜
  destroy: function() {
    console.log('----> stop <----');
    clearInterval(this.timer);
    node = null;
    counter = void 0;
  },
};
document
  .querySelector('.start')
  .addEventListener('click', clock.start.bind(clock), false);
document
  .querySelector('.stop')
  .addEventListener('click', clock.destroy.bind(clock), false);
```

## EventListener

åšç§»åŠ¨å¼€å‘æ—¶ï¼Œéœ€è¦å¯¹ä¸åŒè®¾å¤‡å°ºå¯¸åšé€‚é…ã€‚å¦‚åœ¨å¼€å‘ç»„ä»¶æ—¶ï¼Œæœ‰æ—¶éœ€è¦è€ƒè™‘å¤„ç†æ¨ªç«–å±é€‚é…é—®é¢˜ã€‚ä¸€èˆ¬åšæ³•ï¼Œåœ¨æ¨ªç«–å±å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéœ€è¦å°†ç»„ä»¶é”€æ¯åå†é‡æ–°ç”Ÿæˆã€‚è€Œåœ¨ç»„ä»¶ä¸­ä¼šå¯¹å…¶è¿›è¡Œç›¸å…³äº‹ä»¶ç»‘å®šï¼Œå¦‚æœåœ¨é”€æ¯ç»„ä»¶æ—¶ï¼Œæ²¡æœ‰å°†ç»„ä»¶çš„äº‹ä»¶è§£ç»‘ï¼Œåœ¨æ¨ªç«–å±å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šä¸æ–­åœ°å¯¹ç»„ä»¶è¿›è¡Œäº‹ä»¶ç»‘å®šã€‚è¿™æ ·ä¼šå¯¼è‡´ä¸€äº›å¼‚å¸¸ï¼Œç”šè‡³å¯èƒ½ä¼šå¯¼è‡´é¡µé¢å´©æ‰ã€‚

### å®ä¾‹

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>callbacks</title>
</head>
<body>
  <div class="container"></div>
  <script>
    var container = document.querySelector('.container');
    var counter = 0;
    var createHtml = function (n, counter) {
      var template = `${(new Array(n)).join(`<div>${counter}: this is a new data <input type="button" value="remove"></div>`)}`
      container.innerHTML = template;
    }

    var resizeCallback = function (init) {
      createHtml(10, ++counter);
      // äº‹ä»¶å§”æ‰˜
      container.addEventListener('click', function (event){
        var target = event.target;
          if(target.tagName === 'INPUT'){
              container.removeChild(target.parentElement)
          }
      }, false);
    }
    window.addEventListener('resize', resizeCallback, false);
    resizeCallback(true);
  </script>
</body>
</html>
```

é¡µé¢æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼Œè¿™é‡Œç»“åˆ Devtoolsâ€“>Performance åˆ†æä¸€ä¸‹é—®é¢˜æ‰€åœ¨ï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

<u>**:warning:æ³¨ï¼šæœ€å¥½åœ¨éšè—çª—å£ä¸­è¿›è¡Œåˆ†æå·¥ä½œï¼Œé¿å…æµè§ˆå™¨æ’ä»¶å½±å“åˆ†æç»“æœ**</u>

1.  å¼€å¯ Performance é¡¹çš„è®°å½•
2.  æ‰§è¡Œä¸€æ¬¡ CGï¼Œåˆ›å»ºåŸºå‡†å‚è€ƒçº¿
3.  å¯¹çª—å£å¤§å°è¿›è¡Œè°ƒæ•´
4.  æ‰§è¡Œä¸€æ¬¡ CG
5.  åœæ­¢è®°å½•

![image](https://user-images.githubusercontent.com/22188674/224474562-ee38b81c-d14c-4340-8c60-a0ffb1357029.png)

å¦‚åˆ†æç»“æœæ‰€ç¤ºï¼Œåœ¨çª—å£å¤§å°å˜åŒ–æ—¶ï¼Œä¼šä¸æ–­åœ°å¯¹`container`æ·»åŠ ä»£ç†äº‹ä»¶ã€‚

åŒä¸€ä¸ªå…ƒç´ èŠ‚ç‚¹æ³¨å†Œäº†å¤šä¸ªç›¸åŒçš„ EventListenerï¼Œé‚£ä¹ˆé‡å¤çš„å®ä¾‹ä¼šè¢«æŠ›å¼ƒã€‚è¿™ä¹ˆåšä¸ä¼šè®©å¾— EventListener è¢«é‡å¤è°ƒç”¨ï¼Œä¹Ÿä¸éœ€è¦ç”¨ removeEventListener æ‰‹åŠ¨æ¸…é™¤å¤šä½™çš„ EventListenerï¼Œå› ä¸ºé‡å¤çš„éƒ½è¢«è‡ªåŠ¨æŠ›å¼ƒäº†ã€‚è€Œè¿™æ¡è§„åˆ™åªæ˜¯é’ˆå¯¹äºå‘½åå‡½æ•°ã€‚[å¯¹äºåŒ¿åå‡½æ•°ï¼Œæµè§ˆå™¨ä¼šå°†å…¶çœ‹åšä¸åŒçš„ EventListener](https://triangle717.wordpress.com/2015/12/14/js-avoid-duplicate-listeners/)ï¼Œæ‰€ä»¥åªè¦å°†åŒ¿åçš„ EventListenerï¼Œå‘½åä¸€ä¸‹å°±å¯ä»¥è§£å†³é—®é¢˜ï¼š

```js
var container = document.querySelector('.container');
var counter = 0;
var createHtml = function(n, counter) {
  var template = `${new Array(n).join(
    `<div>${counter}: this is a new data <input type="button" value="remove"></div>`,
  )}`;
  container.innerHTML = template;
};
//
var clickCallback = function(event) {
  var target = event.target;
  if (target.tagName === 'INPUT') {
    container.removeChild(target.parentElement);
  }
};
var resizeCallback = function(init) {
  createHtml(10, ++counter);
  // äº‹ä»¶å§”æ‰˜
  container.addEventListener('click', clickCallback, false);
};
window.addEventListener('resize', resizeCallback, false);
resizeCallback(true);
```

åœ¨ Devtoolsâ€“>Performance ä¸­å†é‡å¤ä¸Šè¿°æ“ä½œï¼Œåˆ†æç»“æœå¦‚ä¸‹ï¼š
![image](https://user-images.githubusercontent.com/22188674/224474599-dd23494a-8bc5-4064-859b-32d2ffa60221.png)

åœ¨å¼€å‘ä¸­ï¼Œå¼€å‘è€…å¾ˆå°‘å…³æ³¨äº‹ä»¶è§£ç»‘ï¼Œå› ä¸ºæµè§ˆå™¨å·²ç»ä¸ºæˆ‘ä»¬å¤„ç†å¾—å¾ˆå¥½äº†ã€‚ä¸è¿‡åœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œå› ä¸ºä¸€èˆ¬ç¬¬ä¸‰æ–¹åº“éƒ½å®ç°äº†è‡ªå·±çš„äº‹ä»¶ç»‘å®šï¼Œå¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œåœ¨éœ€è¦é”€æ¯äº‹ä»¶ç»‘å®šæ—¶ï¼Œæ²¡æœ‰è°ƒç”¨æ‰€è§£ç»‘æ–¹æ³•ï¼Œå°±å¯èƒ½é€ æˆäº‹ä»¶ç»‘å®šæ•°é‡çš„ä¸æ–­å¢åŠ ã€‚å¦‚ä¸‹é“¾æ¥æ˜¯æˆ‘åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ jqueryï¼Œé‡è§åˆ°ç±»ä¼¼é—®é¢˜ï¼š[jQuery ä¸­å¿˜è®°è§£ç»‘æ³¨å†Œçš„äº‹ä»¶ï¼Œé€ æˆå†…å­˜æ³„éœ² â¹ çŒ›å‡» ğŸ˜Š](https://github.com/zhansingsong/js-leakage-patterns/blob/master/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E4%B9%8BListeners/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E4%B9%8BListeners.md)

## æ€»ç»“

æœ¬æ–‡ä¸»è¦ä»‹ç»äº†å‡ ç§å¸¸è§çš„å†…å­˜æ³„éœ²ã€‚åœ¨å¼€å‘è¿‡ç¨‹ï¼Œéœ€è¦æˆ‘ä»¬ç‰¹åˆ«ç•™æ„ä¸€ä¸‹æœ¬æ–‡æ‰€æ¶‰åŠåˆ°çš„å‡ ç§å†…å­˜æ³„éœ²é—®é¢˜ã€‚å› ä¸ºè¿™äº›éšæ—¶å¯èƒ½å‘ç”Ÿåœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¦‚æœæˆ‘ä»¬å¯¹å®ƒä»¬ä¸äº†è§£æ˜¯å¾ˆéš¾å‘ç°å®ƒä»¬çš„å­˜åœ¨ã€‚å¯èƒ½åœ¨å®ƒä»¬å°†é—®é¢˜å½±å“ç¨‹åº¦æ”¾å¤§æ—¶ï¼Œæ‰ä¼šå¼•èµ·æˆ‘ä»¬çš„å…³æ³¨ã€‚ä¸è¿‡é‚£æ—¶å¯èƒ½å°±æ™šäº†ï¼Œå› ä¸ºäº§å“å¯èƒ½å·²ç»ä¸Šçº¿ï¼Œæ¥ç€å°±ä¼šä¸¥é‡å½±å“äº§å“çš„è´¨é‡å’Œç”¨æˆ·ä½“éªŒï¼Œç”šè‡³å¯èƒ½è®©æˆ‘ä»¬æ‰¿å—å¤§é‡ç”¨æˆ·æµå¤±çš„æŸå¤±ã€‚ä½œä¸ºå¼€å‘çš„æˆ‘ä»¬å¿…é¡»æŠŠå¥½è¿™ä¸ªå…³ï¼Œè®©æˆ‘ä»¬å¼€å‘çš„äº§å“å¸¦ç»™ç”¨æˆ·æœ€å¥½çš„ä½“éªŒã€‚

## å‚è€ƒæ–‡ç« ï¼š

* [An interesting kind of JavaScript memory leak](https://blog.meteor.com/an-interesting-kind-of-javascript-memory-leak-8b47d2e7f156)
* [Memory Leaks in Microsoft Internet Explorer](http://isaacschlueter.com/2006/10/msie-memory-leaks/trackback/index.html)
* [Memory leak when logging complex objects](https://stackoverflow.com/questions/12996129/memory-leak-when-logging-complex-objects)

           

## 78.[vue]: vue2.x è™šæ‹Ÿ dom æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿã€webæ¡†æ¶ã€‘
      
## virtual-dom å®ç°ä¹‹ä¸€: snabbdom

vue2.0å°±æ˜¯ä½¿ç”¨çš„snabbdom                 
ä¸€ä¸ªç®€å•çš„ä½¿ç”¨å®ä¾‹ï¼š
```javascript
var snabbdom = require('snabbdom');
var patch = snabbdom.init([ // Init patch function with chosen modules
  require('snabbdom/modules/class').default, // makes it easy to toggle classes
  require('snabbdom/modules/props').default, // for setting properties on DOM elements
  require('snabbdom/modules/style').default, // handles styling on elements with support for animations
  require('snabbdom/modules/eventlisteners').default, // attaches event listeners
]);
var h = require('snabbdom/h').default; // helper function for creating vnodes

var container = document.getElementById('container');

var vnode = h('div#container.two.classes', {on: {click: someFn}}, [
  h('span', {style: {fontWeight: 'bold'}}, 'This is bold'),
  ' and this is just normal text',
  h('a', {props: {href: '/foo'}}, 'I\'ll take you places!')
]);
// Patch into empty DOM element â€“ this modifies the DOM as a side effect
patch(container, vnode);

var newVnode = h('div#container.two.classes', {on: {click: anotherEventHandler}}, [
  h('span', {style: {fontWeight: 'normal', fontStyle: 'italic'}}, 'This is now italic type'),
  ' and this is still just normal text',
  h('a', {props: {href: '/bar'}}, 'I\'ll take you places!')
]);
// Second `patch` invocation
patch(vnode, newVnode); // Snabbdom efficiently updates the old view to the new state
```


### snabbdom æ ¸å¿ƒapi
- snabbdom.init:
  The core exposes only one single function snabbdom.init. This init takes a list of modules and returns a patch function that uses the specified set of modules.
```javascript
var patch = snabbdom.init([
  require('snabbdom/modules/class').default,
  require('snabbdom/modules/style').default,
]);
```

- patch:
```javascript
patch(oldVnode, newVnode);
```

- snabbdom/h:
  It is recommended that you use snabbdom/h to create vnodes. h accepts a tag/selector as a string, an optional data object and an optional string or array of children.
```javascript
var h = require('snabbdom/h').default;
var vnode = h('div', {style: {color: '#000'}}, [
  h('h1', 'Headline'),
  h('p', 'A paragraph'),
]);
```

- snabbdom/tovnode:
  Converts a DOM node into a virtual node. Especially good for patching over an pre-existing, server-side generated content.
```javascript
var snabbdom = require('snabbdom')
var patch = snabbdom.init([ // Init patch function with chosen modules
  require('snabbdom/modules/class').default, // makes it easy to toggle classes
  require('snabbdom/modules/props').default, // for setting properties on DOM elements
  require('snabbdom/modules/style').default, // handles styling on elements with support for animations
  require('snabbdom/modules/eventlisteners').default, // attaches event listeners
]);
var h = require('snabbdom/h').default; // helper function for creating vnodes
var toVNode = require('snabbdom/tovnode').default;

var newVNode = h('div', {style: {color: '#000'}}, [
  h('h1', 'Headline'),
  h('p', 'A paragraph'),
]);

patch(toVNode(document.querySelector('.container')), newVNode)
```

### hå‡½æ•° å’Œ patch çš„ä½¿ç”¨
ä¾‹å¦‚ä¸‹é¢çš„ä¸€ä¸ªdom ç»“æ„ï¼š
```html
<ul id="list">
    <li class="item">item1</li>
    <li class="item">item2</li>
</ul>
```
ç”¨hå‡½æ•°æ¥è¡¨ç¤ºï¼Œå°±å¦‚ä¸‹å½¢å¼ï¼š
```javascript
let vnode = h('ul#list', {}, [
    h('li.item', {}, 'item1'),
    h('li.item', {}, 'item2')
])
```
ä½œç”¨å°±æ˜¯æ¨¡æ‹Ÿçš„ä¸€ä¸ªçœŸå®èŠ‚ç‚¹ã€‚

patchçš„ä½¿ç”¨æ–¹å¼ï¼š                 
ç¬¬ä¸€ç§æ–¹å¼ patch('å®¹å™¨', vnode);  // è¿™ç§ä½¿ç”¨æ–¹å¼æ˜¯ç›´æ¥æ¸²æŸ“dom                            
ç¬¬äºŒç§æ˜¯ç”¨æ–¹å¼: patch(oldVnode, newVnode);         // è¿™ç§æ–¹å¼ä¼šè‡ªåŠ¨å¯¹æ¯”domçš„å·®å¼‚æ€§ï¼Œç„¶ååªæ¸²æŸ“æˆ‘ä»¬éœ€è¦dom;

ä¸€ä¸ªç®€å•çš„ä½¿ç”¨å®ä¾‹ï¼š
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>snabbdom</title>
    <script src="https://cdn.bootcss.com/snabbdom/0.7.1/snabbdom.js"></script>
    <script src="https://cdn.bootcss.com/snabbdom/0.7.1/snabbdom-class.js"></script>
    <script src="https://cdn.bootcss.com/snabbdom/0.7.1/snabbdom-props.js"></script>
    <script src="https://cdn.bootcss.com/snabbdom/0.7.1/snabbdom-style.js"></script>
    <script src="https://cdn.bootcss.com/snabbdom/0.7.1/snabbdom-eventlisteners.js"></script>
    <script src="https://cdn.bootcss.com/snabbdom/0.7.1/h.js"></script>
</head>
<body>
<div id="container"></div><br>

<button id="btn-change">change</button>


<script>
    let snabbdom = window.snabbdom;
    let container = document.getElementById('container');
    let buttonChange = document.getElementById('btn-change');

    // å®šä¹‰patch
    let patch = snabbdom.init([
        snabbdom_class,
        snabbdom_props,
        snabbdom_style,
        snabbdom_eventlisteners
    ]);

    // å®šä¹‰h
    let h = snabbdom.h;

    // ç”Ÿæˆvnode
    let vnode = h('ul#list', {}, [
        h('li.item', {}, 'item1'),
        h('li.item', {}, 'item2')
    ]);
    patch(container, vnode);

    // æ¨¡æ‹Ÿä¸€ä¸ªä¿®æ”¹çš„æƒ…å†µ
    buttonChange.addEventListener('click', function () {
        let newVnode = h('ul#list', {}, [
            h('li.item', {}, 'item1'),
            h('li.item', {}, 'item B'),
            h('li.item', {}, 'item 3')
        ]);
        patch(vnode, newVnode);
    })
</script>
</body>
</html>
```

### snabbdom çš„ä½¿ç”¨å®ä¾‹
```html
<body>
<div id="container"></div>
<br>
<button id="btn-change">change</button>
<script>
    let snabbdom = window.snabbdom;
    let container = document.getElementById('container');
    let buttonChange = document.getElementById('btn-change');

    // å®šä¹‰patch
    let patch = snabbdom.init([
        snabbdom_class,
        snabbdom_props,
        snabbdom_style,
        snabbdom_eventlisteners
    ]);

    // å®šä¹‰h
    let h = snabbdom.h;
    let data = [
        {
            name: 'yanle',
            age: '20',
            address: 'é‡åº†'
        },
        {
            name: 'yanle2',
            age: '25',
            address: 'æˆéƒ½'
        },
        {
            name: 'yanle3',
            age: '27',
            address: 'æ·±åœ³'
        }
    ];

    data.unshift({
        name: 'å§“å',
        age: 'å¹´é¾„',
        address: 'åœ°å€'
    });

    let vnode;
    function render(data) {
        let newVnode = h('table', {style: {'font-size': '16px'}}, data.map(function (item) {
            let tds = [];
            let i ;
            for (i in item) {
                if(item.hasOwnProperty(i)) {
                    tds.push(h('td', {},   h('a', {props: {href: '/foo'}}, item[i])))
                }
            }
            return h('tr', {}, tds)
        }));

        if(vnode) {
            patch(vnode, newVnode);
        } else {
            patch(container, newVnode);
        }

        vnode = newVnode;
    }

    // åˆæ¬¡æ¸²æŸ“
    render(data);
    buttonChange.addEventListener('click', function () {
        data[1].age=30;
        data[1].address = 'éæ´²';
        render(data);
    });
</script>
</body>
```


##  diffç®—æ³•
### æ¦‚å¿µ
å°±æ˜¯æ‰¾å‡ºä¸¤ä¸ªæ–‡ä»¶çš„ä¸åŒ

diff ç®—æ³•æ˜¯éå¸¸å¤æ‚çš„ï¼Œå®ç°éš¾åº¦éå¸¸å¤§ï¼Œ æºç ä¸¤éå¸¸å¤§ã€‚ æ‰€ä»¥éœ€è¦å»ç¹å°±ç®€ï¼Œæ˜ç™½æµç¨‹ï¼Œä¸å…³å¿ƒç»†èŠ‚ã€‚                 
åœ¨vdomä¸­ï¼Œéœ€è¦æ‰¾å‡ºæœ¬æ¬¡dom å¿…é¡»æ›´æ–°çš„èŠ‚ç‚¹æ¥æ›´æ–°ï¼Œå…¶ä»–çš„ä¸ç”¨æ›´æ–°ã€‚æ‰¾å‡ºè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯diffç®—æ³•å®ç°çš„ã€‚æ‰¾å‡ºå‰åä¸¤ä¸ªè™šæ‹Ÿdomçš„å·®å¼‚ã€‚


### diffå®ç°çš„è¿‡ç¨‹
è¿™é‡Œä»¥snabbdomä¸ºä¾‹å­ï¼š                 
patch(container, vnode); patch(vnode, newVnode); è¿™ä¸¤ä¸ªæ–¹æ³•é‡Œé¢å°±ä½¿ç”¨åˆ°äº†diffç®—æ³•ã€‚ ç”¨patchæ–¹æ³•æ¥è§£ædiffç®—æ³•æµç¨‹æ ¸å¿ƒã€‚

**patch(container, vnode)**                             
![02-11-1](https://user-images.githubusercontent.com/22188674/224475327-0b8f19b3-7a35-40ec-960b-6040852f1a7d.png)

å¦‚æœä¸Šé¢çš„æ•°æ®ï¼Œ æˆ‘ä»¬æ€ä¹ˆæ„å»ºçœŸæ­£çš„dom ç»“æ„ï¼š
```javascript
let createElement = function(vnode) {
    let tag = vnode.tag;
    let attrs = vnode.attrs || {};
    let children = vnode.children || {};
    
    if(!tag) return null;
    
    // åˆ›å»ºå…ƒç´ 
    let elem = document.createElement(tag);
    
    // å±æ€§
    let attrName;
    for (attrName in attrs) {
        if(attrs.hasOwnProperty(attrName)) {
            elem.setAttribute(attrName, attrs[attrName])
        }
    }
    
    // å­å…ƒç´ 
    children.forEach(function (childVnode) {
        // ç»™ elem æ·»åŠ å…ƒç´ 
        elem.appendChild(createElement(childVnode))
    });
    
    return elem;
};
```

**patch(vnode, newVnode)**                      
![02-11-2](https://user-images.githubusercontent.com/22188674/224475289-d2f8b10a-1f02-4126-9f2e-b813b0387c84.png)                          
![02-11-3](https://user-images.githubusercontent.com/22188674/224475309-45c68933-3aa8-402a-8353-d09b506e0d46.png)

ä¼ªä»£ç å®ç°å¦‚ä¸‹
```javascript
let createElement = function(vnode) {
    let tag = vnode.tag;
    let attrs = vnode.attrs || {};
    let children = vnode.children || {};

    if(!tag) return null;

    // åˆ›å»ºå…ƒç´ 
    let elem = document.createElement(tag);

    // å±æ€§
    let attrName;
    for (attrName in attrs) {
        if(attrs.hasOwnProperty(attrName)) {
            elem.setAttribute(attrName, attrs[attrName])
        }
    }

    // å­å…ƒç´ 
    children.forEach(function (childVnode) {
        // ç»™ elem æ·»åŠ å…ƒç´ 
        elem.appendChild(createElement(childVnode))
    });

    return elem;
};
```

### diffç®—æ³•çš„å…¶ä»–å†…å®¹
- èŠ‚ç‚¹çš„æ–°å¢å’Œåˆ é™¤
- èŠ‚ç‚¹é‡æ–°æ’åº
- èŠ‚ç‚¹å±æ€§ã€æ ·å¼ã€äº‹ä»¶ç»‘å®š
- å¦‚æœæè‡´å‹æ¦¨æ€§èƒ½

           

## 79.[vue]: æ˜¯å¦‚ä½•å®ç° MVVM çš„ï¼Ÿã€webæ¡†æ¶ã€‘
      


## å¼•å…¥ï¼šä½¿ç”¨jqueryå’Œå…¶ä»–æ¡†æ¶çš„åŒºåˆ«

### åŸç”ŸJSå®ç°ä¸€ä¸ªtodo-list
```html
<body>
<div>
    <input type="text" name="" id="txt-title"> <br>
    <button id="btn-submit">submit</button>
</div>
<div>
    <ul id="ul-list"></ul>
</div>
<script>
    let $txtTitle = document.getElementById('txt-title');
    let $buttonSubmit = document.getElementById('btn-submit');
    let $ulList = document.getElementById('ul-list');
    $buttonSubmit.addEventListener('click', function () {
        let title = $txtTitle.value;
        if(!title) return false;

        let $li = document.createElement('li');
        $li.innerText = title;

        $ulList.appendChild($li);
        $txtTitle.value = '';
    })
</script>
</body>
```


### vueå®ç°todo-list
```html
<body>
<div id="app">
    <div>
        <input v-model="title"> <br>
        <button id="btn-submit" v-on:click="add">submit</button>
    </div>
    <div>
        <ul id="ul-list">
            <li v-for="item in list">{{item}}</li>
        </ul>
    </div>
</div>
<script>
    let vm = new window.Vue({
        el: '#app',
        data: {
            title: '',
            list: []
        },
        methods: {
            add: function () {
                this.list.push(this.title);
                this.title = '';
            }
        }
    })
</script>
</body>
```

### ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«
- æ•°æ®å’Œè§†å›¾åˆ†ç¦»(å¼€æ”¾å°é—­åŸåˆ™ï¼š æ‰©å±•å¼€æ”¾ï¼Œä¿®æ”¹å°é—­)
- æ•°æ®é©±åŠ¨è§†å›¾


### å¯¹mvvmçš„ç†è§£
å…·ä½“çš„ç†è§£è‡ªå·±å†å»æ•´ç†

MVVMæ¡†æ¶çš„ä¸‰å¤§è¦ç´ ï¼š                                                                        
å“åº”å¼ã€æ¨¡æ¿å¼•æ“ã€æ¸²æŸ“


## å“åº”å¼çš„å®ç°
ä¿®æ”¹dataå±æ€§ä¹‹åï¼Œç«‹é©¬å°±èƒ½ç›‘å¬åˆ°ã€‚                 
dataå±æ€§æŒ‚åœ¨åˆ°vmå®ä¾‹ä¸Šé¢ã€‚

æœ‰ä¸‹é¢çš„ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•ç›‘å¬å±æ€§çš„è·å–å’Œå±æ€§çš„èµ‹å€¼çš„ã€‚
```javascript
let obj = {
    name: 'yanle',
    age: 25
};
console.log(obj.name);
obj.age = 26;
```

æ˜¯é€šè¿‡**Object.defineProperty** å®ç°çš„, ä¸‹é¢çš„ä»£ç å°±å¯ä»¥å®ç°ä¸€ä¸ªå®Œæ•´çš„å±æ€§ä¿®æ”¹å’Œè·å–çš„ç›‘å¬ã€‚
```javascript
let vm = {};
let data = {
    name: 'yanle',
    age: 25
};
let key, value;
for (key in data) {
    (function (key) {
        Object.defineProperty(vm, key, {
            get: function () {
                console.log('get', data[key]);
                return data[key];           // dataçš„å±æ€§ä»£ç†åˆ°vm ä¸Š 
            },
            set: function (newValue) {
                console.log('set', newValue);
                data[key] = newValue;
            }
        })
    })(key)
}
```

## vueä¸­çš„æ¨¡æ¿

**æ¨¡æ¿**                              
æœ¬è´¨å°±æ˜¯å­—ç¬¦ä¸²ï¼›                        
æœ‰é€»è¾‘ï¼š if for ç­‰ï¼›                  
è·Ÿhtmlæ ¼å¼å¾ˆåƒï¼Œ ä½†æ˜¯åŒºåˆ«å¾ˆå¤§;                              
æœ€ç»ˆè¦è½¬ä¸ºHTMLæ¥ç°å®ï¼›                               
æ¨¡æ¿éœ€è¦ç”¨JSä»£ç æ¥å®ç°ï¼Œ å› ä¸ºæœ‰é€»è¾‘ï¼Œåªèƒ½ç”¨JSæ¥å®ç°ï¼›


**renderå‡½æ•°-withç”¨æ³•**ï¼š
```javascript
let obj = {
    name: 'yanle',
    age: 20,
    getAddress: function () {
        alert('é‡åº†')
    }
};
// ä¸ç”¨with çš„æƒ…å†µ
// function fn() {
//     alert(obj.name);
//     alert(obj.age);
//     obj.getAddress();
// }
// fn();

// ä½¿ç”¨withçš„æƒ…å†µ
function fn1() {
    with (obj) {
        alert(name);
        alert(age);
        getAddress();
    }
}
fn1();
```
è¿™ç§with çš„ä½¿ç”¨æ–¹æ³•å°±å¦‚ä¸Šæ‰€è¿°ã€‚ä½†æ˜¯å°½é‡ä¸è¦ç”¨ï¼Œå› ä¸ºã€ŠJavaScriptè¯­è¨€ç²¾ç²¹ã€‹ä¸­ï¼Œä½œè€…è¯´è¿‡ï¼Œè¿™ç§ä½¿ç”¨æ–¹å¼ä¼šç»™ä»£ç çš„è°ƒè¯•å¸¦æ¥éå¸¸å¤§çš„å›°éš¾ã€‚                               
ä½†æ˜¯vueæºç ä¸­çš„render å°±æ˜¯ç”¨çš„è¿™ä¸ª;


**renderå‡½æ•°**:                                   
<img width="274" alt="02-12-1" src="https://user-images.githubusercontent.com/22188674/224475416-9567c516-981f-4399-9128-4efcb70e8502.png">                               
![02-12-2](https://user-images.githubusercontent.com/22188674/224475405-34baf640-f897-4a26-9817-109e8b4c1bde.png)

æ¨¡æ¿ä¸­çš„æ‰€æœ‰ä¿¡æ¯éƒ½åŒ…å«åœ¨äº†render å‡½æ•°ä¸­ã€‚                        
ä¸€ä¸ªç‰¹åˆ«ç®€å•çš„ç¤ºä¾‹:
```javascript
let vm = new Vue({
        el: '#app',
        data: {
            price: 200
        }
    });

    // ä¸€ä¸‹æ˜¯æ‰‹å†™çš„
    function render() {
        with (this) {               // å°±æ˜¯vm
            _c(
                'div',
                {
                    attr: {'id': 'app'}
                },
                [
                    _c('p', [_v(_s(price))])
                ]
            )
        }
    }

    function render1() {
        return vm._c(
            'div',
            {
                attr: {'id': 'app'}
            },
            [
                _c('p', [vm._v(vm._s(vm.price))])       // vm._v æ˜¯åˆ›å»ºæ–‡æœ¬ï¼Œ _s å°±æ˜¯toString
            ]
        )
    }
```

å¦‚æœæˆ‘ä»¬ç”¨ä¸€ä¸ªå¤æ‚çš„ä¾‹å­æ¥æè¿°è¿™ä¸ªä¸œè¥¿ã€‚åœ¨æºç ä¸­ï¼Œ æœç´¢code.render, ç„¶ååœ¨åœ¨æ­¤ä¹‹å‰æ‰“å°render å‡½æ•°ï¼Œå°±å¯ä»¥çœ‹çœ‹è¿™ä¸ªåˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿äº†ã€‚
```javascript
var createCompiler = createCompilerCreator(function baseCompile (
    template,
    options
) {
    var ast = parse(template.trim(), options);
    if (options.optimize !== false) {
        optimize(ast, options);
    }
    var code = generate(ast, options);
    console.log(code.render);
    return {
        ast: ast,
        render: code.render,
        staticRenderFns: code.staticRenderFns
    }
});
```
ç„¶åè¿è¡Œï¼Œ å°±å¯ä»¥çœ‹åˆ°åˆ°åº•render å‡½æ•°æ˜¯ä»€ä¹ˆä¸œè¥¿äº†ã€‚ å°±å¯ä»¥æˆªå–æºç å‡ºæ¥çœ‹äº†ã€‚                  
ç›¸å¯¹åº”çš„æ¨¡æ¿å¦‚ä¸‹:
```html
<div id="app">
    <div>
        <input v-model="title"> <br>
        <button id="btn-submit" v-on:click="add">submit</button>
    </div>
    <div>
        <ul id="ul-list">
            <li v-for="item in list">{{item}}</li>
        </ul>
    </div>
</div>
```
æˆªå–çš„renderå‡½æ•°å¦‚ä¸‹ï¼š
```javascript
function codeRender() {
    with (this) {
        return _c('div',
            {attrs: {"id": "app"}},
            [
                _c('div', [
                    _c('input', {
                        directives: [{
                            name: "model",
                            rawName: "v-model",
                            value: (title),             // æ¸²æŸ“ æŒ‡å®šæ•°æ®
                            expression: "title"
                        }],
                        domProps: {"value": (title)},   // æ¸²æŸ“ æŒ‡å®šæ•°æ®
                        on: {                       // é€šè¿‡inputè¾“å…¥äº‹ä»¶ï¼Œ ä¿®æ”¹title
                            "input": function ($event) {
                                if ($event.target.composing) return;
                                title = $event.target.value
                            }
                        }
                    }),
                    _v(" "),                // æ–‡æœ¬èŠ‚ç‚¹
                    _c('br'),
                    _v(" "),
                    _c('button', {          // dom èŠ‚ç‚¹
                            attrs: {"id": "btn-submit"},
                            on: {"click": add}              // methods é‡Œé¢çš„ä¸œè¥¿ä¹Ÿéƒ½æŒ‚åœ¨thisä¸Šé¢å»äº†
                        },
                        [_v("submit")])]),

                _v(" "),

                _c('div', [
                    _c('ul',
                        {attrs: {"id": "ul-list"}},
                        _l((list), function (item) {                // æ•°ç»„èŠ‚ç‚¹
                            return _c('li', [_v(_s(item))])
                        })
                    )
                ])
            ])
    }
}
```
ä»vue2.0å¼€å§‹æ”¯æŒé¢„ç¼–è¯‘ï¼Œ æˆ‘ä»¬åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œå†™æ¨¡æ¿ï¼Œ ç¼–è¯‘æ‰“åŒ…ä¹‹åï¼Œ æ¨¡æ¿å°±å˜æˆäº†JSä»£ç äº†ã€‚vueå·²ç»æœ‰å·¥å…·æ”¯æŒè¿™ä¸ªè¿‡ç¨‹ã€‚


## vueä¸­çš„æ¸²æŸ“
vueçš„æ¸²æŸ“æ˜¯ç›´æ¥æ¸²æŸ“ä¸ºè™šæ‹Ÿdom ,è¿™ä¸€å—å„¿çš„å†…å®¹ï¼Œå…¶å®æ˜¯å€Ÿé‰´çš„snabbdom, éå¸¸ç›¸ä¼¼ï¼Œå¯ä»¥å»çœ‹çœ‹snabbdom å°±å¯ä»¥ä¸€ç›®äº†ç„¶äº†ã€‚                         
vueä¸­çš„å…·ä½“æ¸²æŸ“å®ç°:                        
![02-12-03](https://user-images.githubusercontent.com/22188674/224475434-c4e33700-d223-4472-8e96-5cc7b6c04d70.png)



## æ•´ä½“æµç¨‹çš„å®ç°

ç¬¬ä¸€æ­¥ï¼š è§£ææ¨¡æ¿å½¢æˆrender å‡½æ•°
- with ç”¨æ³•
- æ¨¡æ¿ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è¢«render å‡½æ•°åŒ…å«
- æ¨¡æ¿ä¸­dataçš„å±æ€§ï¼Œå˜æˆäº†JSå˜é‡
- æ¨¡æ¿ä¸­çš„v-modelã€v-forã€v-onéƒ½å˜æˆäº†JSçš„é€»è¾‘
- renderå‡½æ•°è¿”å›vnode

ç¬¬äºŒæ­¥ï¼š å“åº”å¼å¼€å§‹ç›‘å¬æ•°æ®å˜åŒ–
- Object.defineProperty çš„ä½¿ç”¨
- è®²dataä¸­çš„å±æ€§ä»£ç†åˆ°vm ä¸Š

ç¬¬ä¸‰æ­¥ï¼š é¦–æ¬¡æ¸²æŸ“ï¼Œæ˜¾ç¤ºé¡µé¢ï¼Œè€Œä¸”ç»‘å®šæ•°æ®å’Œä¾èµ–
- åˆæ¬¡æ¸²æŸ“ï¼Œ æ‰§è¡ŒupdateComponent, æ‰§è¡Œvm._render();
- æ‰§è¡Œrenderå‡½æ•°ï¼Œ ä¼šè®¿é—®åˆ°vm.listå’Œvm.titleç­‰å·²ç»ç»‘å®šå¥½äº†çš„æ•°æ®ï¼›
- ä¼šè¢«è¯¦æƒ…æ˜¯çš„get æ–¹æ³•ç›‘å¬åˆ°                           
  ä¸ºä½•ä¸€å®šè¦ç›‘å¬get, ç›´æ¥ç›‘å¬set ä¸è¡Œå—ï¼Ÿ dataä¸­æœ‰å¾ˆå¤šçš„å±æ€§ï¼Œæœ‰çš„è¢«ç”¨åˆ°äº†ï¼Œæœ‰çš„æ²¡æœ‰è¢«ç”¨åˆ°ã€‚è¢«ç”¨åˆ°çš„ä¼šèµ°get, ä¸è¢«ç”¨åˆ°çš„ä¸ä¼šèµ°getã€‚
  æ²¡æœ‰è¢«getç›‘å¬çš„å±æ€§ï¼Œsetçš„æ—¶å€™ä¹Ÿä¸ä¼šè¢«åšæŒºã€‚ä¸ºçš„å°±æ˜¯å‡å°‘ä¸å¿…è¦çš„é‡å¤æ¸²æŸ“ï¼ŒèŠ‚çœæ€§èƒ½ã€‚
- æ‰§è¡ŒupdateComponentçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œvdomçš„patchæ–¹æ³•
- patch è®²vnodeæ¸²æŸ“ä¸ºDOMï¼Œ åˆæ¬¡æ¸²æŸ“å®Œæˆ

ç¬¬å››æ­¥ï¼š dataå±æ€§å˜åŒ–ï¼Œå‡ºå‘render
- ä¿®æ”¹å±æ€§å€¼ï¼Œ ä¼šè¢«å“åº”å¼çš„setç›‘å¬åˆ°
- setä¸­ä¼šæ‰§è¡ŒupdateComponentï¼Œ é‡æ–°æ‰§è¡Œvm.render()
- ç”Ÿæˆvnodeå’ŒprevVnode, é€šè¿‡patchè¿›è¡Œå¯¹æ¯”
- æ¸²æŸ“åˆ°htmlä¸­  

           

## 80.[Redux]: çœ‹è¿‡ Redux æºç å—ï¼Œ å¯¹ Redux äº†è§£å¤šå°‘ï¼Ÿã€webæ¡†æ¶ã€‘
      
## æ·±å…¥Reduxæ¶æ„

ç›®å½•ï¼š
- [1ã€å…³äºredux](#01)
- [2ã€API](#02)
- [3ã€ä¸­é—´ä»¶ä¸å¼‚æ­¥æ“ä½œ](#03)
- [4ã€å¼‚æ­¥æ“ä½œçš„åŸºæœ¬æ€è·¯](#04)
- [5ã€React-Reduxçš„ç”¨æ³•](#05)

å‚è€ƒæ–‡ç« ï¼š[http://www.cnblogs.com/MuYunyun/p/6530715.html](http://www.cnblogs.com/MuYunyun/p/6530715.html)

## <div id="01">1ã€å…³äºredux</div>

### 1.1ã€ä»€ä¹ˆæƒ…å†µéœ€è¦ç”¨reduxï¼Ÿ
- ç”¨æˆ·çš„ä½¿ç”¨æ–¹å¼å¤æ‚
- ä¸åŒèº«ä»½çš„ç”¨æˆ·æœ‰ä¸åŒçš„ä½¿ç”¨æ–¹å¼ï¼ˆæ¯”å¦‚æ™®é€šç”¨æˆ·å’Œç®¡ç†å‘˜ï¼‰
- å¤šä¸ªç”¨æˆ·ä¹‹é—´å¯ä»¥åä½œ
- ä¸æœåŠ¡å™¨å¤§é‡äº¤äº’ï¼Œæˆ–è€…ä½¿ç”¨äº†WebSocket
- Viewè¦ä»å¤šä¸ªæ¥æºè·å–æ•°æ®

ç®€å•è¯´ï¼Œå¦‚æœä½ çš„UIå±‚éå¸¸ç®€å•ï¼Œæ²¡æœ‰å¾ˆå¤šäº’åŠ¨ï¼ŒRedux å°±æ˜¯ä¸å¿…è¦çš„ï¼Œç”¨äº†åè€Œå¢åŠ å¤æ‚æ€§ã€‚å¤šäº¤äº’ã€å¤šæ•°æ®æºåœºæ™¯å°±æ¯”è¾ƒé€‚åˆä½¿ç”¨Reduxã€‚

### 1.2ã€è®¾è®¡æ€æƒ³
- Web åº”ç”¨æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œè§†å›¾ä¸çŠ¶æ€æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚
- æ‰€æœ‰çš„çŠ¶æ€ï¼Œä¿å­˜åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œé¢ã€‚

### 1.3ã€Reduxå·¥ä½œæµç¨‹

![react04-01](https://user-images.githubusercontent.com/22188674/224475588-53d35049-5ed3-4921-bd35-847a3859b23b.png)                           

é¦–å…ˆï¼Œç”¨æˆ·å‘å‡º Actionã€‚                         
`store.dispatch(action);`                               

ç„¶åï¼ŒStore è‡ªåŠ¨è°ƒç”¨ Reducerï¼Œå¹¶ä¸”ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼šå½“å‰ State å’Œæ”¶åˆ°çš„ Actionã€‚ Reducer ä¼šè¿”å›æ–°çš„ State ã€‚                                                    
`let nextState = todoApp(previousState, action);`


State ä¸€æ—¦æœ‰å˜åŒ–ï¼ŒStore å°±ä¼šè°ƒç”¨ç›‘å¬å‡½æ•°ã€‚                                 
// è®¾ç½®ç›‘å¬å‡½æ•°                       
`store.subscribe(listener);`

listenerå¯ä»¥é€šè¿‡store.getState()å¾—åˆ°å½“å‰çŠ¶æ€ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯ Reactï¼Œè¿™æ—¶å¯ä»¥è§¦å‘é‡æ–°æ¸²æŸ“ Viewã€‚                                
```javascript
function listerner() {
  let newState = store.getState();
  component.setState(newState);   
}
```

å¦‚æœç°åœ¨æ²¡ç†è§£ä»¥ä¸Šæµç¨‹ï¼Œä¸è¦æ€¥ï¼Œçœ‹å®Œä»¥ä¸‹APIå°±å·®ä¸å¤šèƒ½æ‡‚å¾—Reduxçš„æ ¸å¿ƒæœºåˆ¶äº†ã€‚

## <div id="02">2ã€API</div>                         

### Store
Store å°±æ˜¯ä¿å­˜æ•°æ®çš„åœ°æ–¹ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ä¸ªå®¹å™¨ã€‚æ•´ä¸ªåº”ç”¨åªèƒ½æœ‰ä¸€ä¸ª Storeã€‚

Redux æä¾›createStoreè¿™ä¸ªå‡½æ•°ï¼Œç”¨æ¥ç”Ÿæˆ Storeã€‚                     
ä¸‹é¢ä»£ç ä¸­ï¼ŒcreateStoreå‡½æ•°æ¥å—å¦ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¿”å›æ–°ç”Ÿæˆçš„ Store å¯¹è±¡ã€‚                         
```javascript
import { createStore } from 'redux';
const store = createStore(fn);
```

### State
Storeå¯¹è±¡åŒ…å«æ‰€æœ‰æ•°æ®ã€‚å¦‚æœæƒ³å¾—åˆ°æŸä¸ªæ—¶ç‚¹çš„æ•°æ®ï¼Œå°±è¦å¯¹ Store ç”Ÿæˆå¿«ç…§ã€‚è¿™ç§æ—¶ç‚¹çš„æ•°æ®é›†åˆï¼Œå°±å«åš Stateã€‚                          
å½“å‰æ—¶åˆ»çš„ Stateï¼Œå¯ä»¥é€šè¿‡store.getState()æ‹¿åˆ°ã€‚
```javascript
import { createStore } from 'redux';
const store = createStore(fn);

const state = store.getState();
```
Redux è§„å®šï¼Œ ä¸€ä¸ª State å¯¹åº”ä¸€ä¸ª Viewã€‚åªè¦ State ç›¸åŒï¼ŒView å°±ç›¸åŒã€‚ä½ çŸ¥é“ Stateï¼Œå°±çŸ¥é“ View æ˜¯ä»€ä¹ˆæ ·ï¼Œåä¹‹äº¦ç„¶ã€‚


### Action
State çš„å˜åŒ–ï¼Œä¼šå¯¼è‡´ View çš„å˜åŒ–ã€‚ä½†æ˜¯ï¼Œç”¨æˆ·æ¥è§¦ä¸åˆ° Stateï¼Œåªèƒ½æ¥è§¦åˆ° Viewã€‚æ‰€ä»¥ï¼ŒState çš„å˜åŒ–å¿…é¡»æ˜¯ View å¯¼è‡´çš„ã€‚Action å°±æ˜¯ View å‘å‡ºçš„é€šçŸ¥ï¼Œè¡¨ç¤º State åº”è¯¥è¦å‘ç”Ÿå˜åŒ–äº†ã€‚                          
Action æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å…¶ä¸­çš„typeå±æ€§æ˜¯å¿…é¡»çš„ï¼Œè¡¨ç¤º Action çš„åç§°ã€‚å…¶ä»–å±æ€§å¯ä»¥è‡ªç”±è®¾ç½®ï¼Œç¤¾åŒºæœ‰ä¸€ä¸ªè§„èŒƒå¯ä»¥å‚è€ƒã€‚                                
```javascript
const action = {
  type: 'ADD_TODO',
  payload: 'Learn Redux'
};
```
ä¸Šé¢ä»£ç ä¸­ï¼ŒAction çš„åç§°æ˜¯ADD_TODOï¼Œå®ƒæºå¸¦çš„ä¿¡æ¯æ˜¯å­—ç¬¦ä¸²Learn Reduxã€‚                        
å¯ä»¥è¿™æ ·ç†è§£ï¼ŒAction æè¿°å½“å‰å‘ç”Ÿçš„äº‹æƒ…ã€‚æ”¹å˜ State çš„å”¯ä¸€åŠæ³•ï¼Œå°±æ˜¯ä½¿ç”¨ Actionã€‚å®ƒä¼šè¿é€æ•°æ®åˆ° Storeã€‚


### Action Creator
View è¦å‘é€å¤šå°‘ç§æ¶ˆæ¯ï¼Œå°±ä¼šæœ‰å¤šå°‘ç§ Actionã€‚å¦‚æœéƒ½æ‰‹å†™ï¼Œä¼šå¾ˆéº»çƒ¦ã€‚å¯ä»¥å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥ç”Ÿæˆ Actionï¼Œè¿™ä¸ªå‡½æ•°å°±å« Action Creatorã€‚                    
```javascript
const ADD_TODO = 'æ·»åŠ  TODO';

function addTodo(text) {
  return {
    type: ADD_TODO,
    text
  }
}
const action = addTodo('Learn Redux');
```

### store.dispatch()
store.dispatch()æ˜¯ View å‘å‡º Action çš„å”¯ä¸€æ–¹æ³•ã€‚                     
```javascript
import { createStore } from 'redux';
const store = createStore(fn);

store.dispatch({
  type: 'ADD_TODO',
  payload: 'Learn Redux'
});
```
ä¸Šé¢ä»£ç ä¸­ï¼Œstore.dispatchæ¥å—ä¸€ä¸ª Action å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå°†å®ƒå‘é€å‡ºå»ã€‚                          
ç»“åˆ Action Creatorï¼Œè¿™æ®µä»£ç å¯ä»¥æ”¹å†™å¦‚ä¸‹ã€‚
```javascript
store.dispatch(addTodo('Learn Redux'));
```

### Reducer
Store æ”¶åˆ° Action ä»¥åï¼Œå¿…é¡»ç»™å‡ºä¸€ä¸ªæ–°çš„ Stateï¼Œè¿™æ · View æ‰ä¼šå‘ç”Ÿå˜åŒ–ã€‚è¿™ç§ State çš„è®¡ç®—è¿‡ç¨‹å°±å«åš Reducerã€‚                             
Reducer æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å— Action å’Œå½“å‰ State ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ Stateã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå®é™…çš„ä¾‹å­
```javascript
const defaultState = 0;
const reducer = (state = defaultState, action) => {
  switch (action.type) {
    case 'ADD':
      return state + action.payload;
    default: 
      return state;
  }
};

const state = reducer(1, {
  type: 'ADD',
  payload: 2
});
```
ä¸Šé¢ä»£ç ä¸­ï¼Œreducerå‡½æ•°æ”¶åˆ°åä¸ºADDçš„ Action ä»¥åï¼Œå°±è¿”å›ä¸€ä¸ªæ–°çš„ Stateï¼Œä½œä¸ºåŠ æ³•çš„è®¡ç®—ç»“æœã€‚
å…¶ä»–è¿ç®—çš„é€»è¾‘ï¼ˆæ¯”å¦‚å‡æ³•ï¼‰ï¼Œä¹Ÿå¯ä»¥æ ¹æ® Action çš„ä¸åŒæ¥å®ç°ã€‚                                        
å®é™…åº”ç”¨ä¸­ï¼ŒReducer å‡½æ•°ä¸ç”¨åƒä¸Šé¢è¿™æ ·æ‰‹åŠ¨è°ƒç”¨ï¼Œstore.dispatchæ–¹æ³•ä¼šè§¦å‘ Reducer çš„è‡ªåŠ¨æ‰§è¡Œã€‚
ä¸ºæ­¤ï¼ŒStore éœ€è¦çŸ¥é“ Reducer å‡½æ•°ï¼Œåšæ³•å°±æ˜¯åœ¨ç”Ÿæˆ Store çš„æ—¶å€™ï¼Œå°† Reducer ä¼ å…¥createStoreæ–¹æ³•ã€‚                           
```javascript
import { createStore } from 'redux';
const store = createStore(reducer);
```
ä¸Šé¢ä»£ç ä¸­ï¼ŒcreateStoreæ¥å— Reducer ä½œä¸ºå‚æ•°ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ Storeã€‚
ä»¥åæ¯å½“store.dispatchå‘é€è¿‡æ¥ä¸€ä¸ªæ–°çš„ Actionï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨ Reducerï¼Œå¾—åˆ°æ–°çš„ Stateã€‚


### store.subscribe()
Store å…è®¸ä½¿ç”¨store.subscribeæ–¹æ³•è®¾ç½®ç›‘å¬å‡½æ•°ï¼Œä¸€æ—¦ State å‘ç”Ÿå˜åŒ–ï¼Œå°±è‡ªåŠ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°ã€‚                      
```javascript
import { createStore } from 'redux';
const store = createStore(reducer);

store.subscribe(listener);
```
æ˜¾ç„¶ï¼Œåªè¦æŠŠ View çš„æ›´æ–°å‡½æ•°ï¼ˆå¯¹äº React é¡¹ç›®ï¼Œå°±æ˜¯ç»„ä»¶çš„renderæ–¹æ³•æˆ–setStateæ–¹æ³•ï¼‰æ”¾å…¥listenï¼Œå°±ä¼šå®ç° View çš„è‡ªåŠ¨æ¸²æŸ“ã€‚                        
store.subscribeæ–¹æ³•è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°å°±å¯ä»¥è§£é™¤ç›‘å¬ã€‚                      
```javascript
let unsubscribe = store.subscribe(() =>
  console.log(store.getState())
);
unsubscribe();
```


## <div id="03">3ã€ä¸­é—´ä»¶ä¸å¼‚æ­¥æ“ä½œ</div>
ä¸€ä¸ªå…³é”®é—®é¢˜æ²¡æœ‰è§£å†³ï¼šå¼‚æ­¥æ“ä½œæ€ä¹ˆåŠï¼ŸAction å‘å‡ºä»¥åï¼ŒReducer ç«‹å³ç®—å‡º Stateï¼Œè¿™å«åšåŒæ­¥ï¼›Action å‘å‡ºä»¥åï¼Œè¿‡ä¸€æ®µæ—¶é—´å†æ‰§è¡Œ Reducerï¼Œè¿™å°±æ˜¯å¼‚æ­¥ã€‚                             
æ€ä¹ˆæ‰èƒ½ Reducer åœ¨å¼‚æ­¥æ“ä½œç»“æŸåè‡ªåŠ¨æ‰§è¡Œå‘¢ï¼Ÿè¿™å°±è¦ç”¨åˆ°æ–°çš„å·¥å…·ï¼šä¸­é—´ä»¶ï¼ˆmiddlewareï¼‰ã€‚

ä¸ºäº†ç†è§£ä¸­é—´ä»¶ï¼Œè®©æˆ‘ä»¬ç«™åœ¨æ¡†æ¶ä½œè€…çš„è§’åº¦æ€è€ƒé—®é¢˜ï¼šå¦‚æœè¦æ·»åŠ åŠŸèƒ½ï¼Œä½ ä¼šåœ¨å“ªä¸ªç¯èŠ‚æ·»åŠ ï¼Ÿ                         
ï¼ˆ1ï¼‰Reducerï¼šçº¯å‡½æ•°ï¼Œåªæ‰¿æ‹…è®¡ç®— State çš„åŠŸèƒ½ï¼Œä¸åˆé€‚æ‰¿æ‹…å…¶ä»–åŠŸèƒ½ï¼Œä¹Ÿæ‰¿æ‹…ä¸äº†ï¼Œå› ä¸ºç†è®ºä¸Šï¼Œçº¯å‡½æ•°ä¸èƒ½è¿›è¡Œè¯»å†™æ“ä½œã€‚                       
ï¼ˆ2ï¼‰Viewï¼šä¸ State ä¸€ä¸€å¯¹åº”ï¼Œå¯ä»¥çœ‹ä½œ State çš„è§†è§‰å±‚ï¼Œä¹Ÿä¸åˆé€‚æ‰¿æ‹…å…¶ä»–åŠŸèƒ½ã€‚                        
ï¼ˆ3ï¼‰Actionï¼šå­˜æ”¾æ•°æ®çš„å¯¹è±¡ï¼Œå³æ¶ˆæ¯çš„è½½ä½“ï¼Œåªèƒ½è¢«åˆ«äººæ“ä½œï¼Œè‡ªå·±ä¸èƒ½è¿›è¡Œä»»ä½•æ“ä½œã€‚                        
æƒ³æ¥æƒ³å»ï¼Œåªæœ‰å‘é€ Action çš„è¿™ä¸ªæ­¥éª¤ï¼Œå³store.dispatch()æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ åŠŸèƒ½ã€‚                              

### ä¸­é—´ä»¶çš„ç”¨æ³•
æœ¬æ–‡ä¸æ¶‰åŠå¦‚ä½•ç¼–å†™ä¸­é—´ä»¶ï¼Œå› ä¸ºå¸¸ç”¨çš„ä¸­é—´ä»¶éƒ½æœ‰ç°æˆçš„ï¼Œåªè¦å¼•ç”¨åˆ«äººå†™å¥½çš„æ¨¡å—å³å¯ã€‚                       
```javascript
import { applyMiddleware, createStore } from 'redux';
import createLogger from 'redux-logger';
const logger = createLogger();

const store = createStore(
  reducer,
  applyMiddleware(logger)
);
```

ä¸Šé¢ä»£ç ä¸­ï¼Œredux-loggeræä¾›ä¸€ä¸ªç”Ÿæˆå™¨createLoggerï¼Œå¯ä»¥ç”Ÿæˆæ—¥å¿—ä¸­é—´ä»¶loggerã€‚
ç„¶åï¼Œå°†å®ƒæ”¾åœ¨applyMiddlewareæ–¹æ³•ä¹‹ä¸­ï¼Œä¼ å…¥createStoreæ–¹æ³•ï¼Œå°±å®Œæˆäº†store.dispatch()çš„åŠŸèƒ½å¢å¼ºã€‚

è¿™é‡Œæœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š
ï¼ˆ1ï¼‰createStoreæ–¹æ³•å¯ä»¥æ¥å—æ•´ä¸ªåº”ç”¨çš„åˆå§‹çŠ¶æ€ä½œä¸ºå‚æ•°ï¼Œé‚£æ ·çš„è¯ï¼ŒapplyMiddlewareå°±æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°äº†ã€‚
```javascript
const store = createStore(
  reducer,
  initial_state,
  applyMiddleware(logger)
);
```

ï¼ˆ2ï¼‰ä¸­é—´ä»¶çš„æ¬¡åºæœ‰è®²ç©¶ã€‚
```javascript
const store = createStore(
  reducer,
  applyMiddleware(thunk, promise, logger)
);
```
ä¸Šé¢ä»£ç ä¸­ï¼ŒapplyMiddlewareæ–¹æ³•çš„ä¸‰ä¸ªå‚æ•°ï¼Œå°±æ˜¯ä¸‰ä¸ªä¸­é—´ä»¶ã€‚æœ‰çš„ä¸­é—´ä»¶æœ‰æ¬¡åºè¦æ±‚ï¼Œä½¿ç”¨å‰è¦æŸ¥ä¸€ä¸‹æ–‡æ¡£ã€‚æ¯”å¦‚ï¼Œloggerå°±ä¸€å®šè¦æ”¾åœ¨æœ€åï¼Œå¦åˆ™è¾“å‡ºç»“æœä¼šä¸æ­£ç¡®ã€‚


## <div id="04">4ã€å¼‚æ­¥æ“ä½œçš„åŸºæœ¬æ€è·¯</div>

ç†è§£äº†ä¸­é—´ä»¶ä»¥åï¼Œå°±å¯ä»¥å¤„ç†å¼‚æ­¥æ“ä½œäº†ã€‚

åŒæ­¥æ“ä½œåªè¦å‘å‡ºä¸€ç§ Action å³å¯ï¼Œå¼‚æ­¥æ“ä½œçš„å·®åˆ«æ˜¯å®ƒè¦å‘å‡ºä¸‰ç§ Actionã€‚                                 
- æ“ä½œå‘èµ·æ—¶çš„ Action
- æ“ä½œæˆåŠŸæ—¶çš„ Action
- æ“ä½œå¤±è´¥æ—¶çš„ Action

ä»¥å‘æœåŠ¡å™¨å–å‡ºæ•°æ®ä¸ºä¾‹ï¼Œä¸‰ç§ Action å¯ä»¥æœ‰ä¸¤ç§ä¸åŒçš„å†™æ³•ã€‚
```
// å†™æ³•ä¸€ï¼šåç§°ç›¸åŒï¼Œå‚æ•°ä¸åŒ
{ type: 'FETCH_POSTS' }
{ type: 'FETCH_POSTS', status: 'error', error: 'Oops' }
{ type: 'FETCH_POSTS', status: 'success', response: { ... } }

// å†™æ³•äºŒï¼šåç§°ä¸åŒ
{ type: 'FETCH_POSTS_REQUEST' }
{ type: 'FETCH_POSTS_FAILURE', error: 'Oops' }
{ type: 'FETCH_POSTS_SUCCESS', response: { ... } }
```

é™¤äº† Action ç§ç±»ä¸åŒï¼Œå¼‚æ­¥æ“ä½œçš„ State ä¹Ÿè¦è¿›è¡Œæ”¹é€ ï¼Œåæ˜ ä¸åŒçš„æ“ä½œçŠ¶æ€ã€‚ä¸‹é¢æ˜¯ State çš„ä¸€ä¸ªä¾‹å­ã€‚
```javascript
let state = {
  // ... 
  isFetching: true,
  didInvalidate: true,
  lastUpdated: 'xxxxxxx'
};
```
ä¸Šé¢ä»£ç ä¸­ï¼ŒState çš„å±æ€§isFetchingè¡¨ç¤ºæ˜¯å¦åœ¨æŠ“å–æ•°æ®ã€‚didInvalidateè¡¨ç¤ºæ•°æ®æ˜¯å¦è¿‡æ—¶ï¼ŒlastUpdatedè¡¨ç¤ºä¸Šä¸€æ¬¡æ›´æ–°æ—¶é—´ã€‚

ç°åœ¨ï¼Œæ•´ä¸ªå¼‚æ­¥æ“ä½œçš„æ€è·¯å°±å¾ˆæ¸…æ¥šäº†ã€‚                              
- æ“ä½œå¼€å§‹æ—¶ï¼Œé€å‡ºä¸€ä¸ª Actionï¼Œè§¦å‘ State æ›´æ–°ä¸º"æ­£åœ¨æ“ä½œ"çŠ¶æ€ï¼ŒView é‡æ–°æ¸²æŸ“
- æ“ä½œç»“æŸåï¼Œå†é€å‡ºä¸€ä¸ª Actionï¼Œè§¦å‘ State æ›´æ–°ä¸º"æ“ä½œç»“æŸ"çŠ¶æ€ï¼ŒView å†ä¸€æ¬¡é‡æ–°æ¸²æŸ“

### æ€»ç»“
åœ¨å¼‚æ­¥è¯·æ±‚çš„æ—¶å€™ï¼Œå…¶å®å¾ˆå¤šæ—¶å€™éƒ½æ˜¯ç›´æ¥å‘å‡ºè¯·æ±‚å¦‚æœè¯·æ±‚æˆåŠŸäº†ä¹‹åï¼Œåœ¨å­˜å…¥reducers, å¹¶ä¸æ˜¯ä¸ç®¡æˆåŠŸä¸å¦ï¼Œéƒ½å­˜å…¥reducersã€‚                                        


### redux-thunkä¸­é—´ä»¶
å¼‚æ­¥æ“ä½œè‡³å°‘è¦é€å‡ºä¸¤ä¸ª Actionï¼šç”¨æˆ·è§¦å‘ç¬¬ä¸€ä¸ª Actionï¼Œè¿™ä¸ªè·ŸåŒæ­¥æ“ä½œä¸€æ ·ï¼Œæ²¡æœ‰é—®é¢˜ï¼›å¦‚ä½•æ‰èƒ½åœ¨æ“ä½œç»“æŸæ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨é€å‡ºç¬¬äºŒä¸ª Action å‘¢ï¼Ÿ
å¥¥å¦™å°±åœ¨ Action Creator ä¹‹ä¸­ã€‚
```javascript
class AsyncApp extends Component {
  componentDidMount() {
    const { dispatch, selectedPost } = this.props
    dispatch(getApplyList(selectedPost))
  }
}
// ...
```
ä¸Šé¢ä»£ç æ˜¯ä¸€ä¸ªå¼‚æ­¥ç»„ä»¶çš„ä¾‹å­ã€‚åŠ è½½æˆåŠŸåï¼ˆcomponentDidMountæ–¹æ³•ï¼‰ï¼Œå®ƒé€å‡ºäº†ï¼ˆdispatchæ–¹æ³•ï¼‰ä¸€ä¸ª Actionï¼Œå‘æœåŠ¡å™¨è¦æ±‚æ•°æ® fetchPosts(selectedSubreddit)ã€‚
è¿™é‡Œçš„fetchPostså°±æ˜¯ Action Creatorã€‚                         
ä¸‹é¢å°±æ˜¯getApplyListçš„ä»£ç ï¼Œå…³é”®ä¹‹å¤„å°±åœ¨é‡Œé¢ï¼Œ è¿™æ˜¯æˆ‘åœ¨å…¬å¸çš„ä»£ç é£æ ¼å†™æ³•ã€‚
```javascript
export function getApplyList(query) {
    return function(dispatch) {
        dispatch(modalUpdate({
            loadingTable: true
        }));
        fetch('apply', query)
            .then(function(res) {
                dispatch(updateApply(res.data));                // è¿™ä¸ªæ˜¯è°ƒç”¨çš„action Mppper
                dispatch(modalUpdate({
                    loadingTable: false
                }));
            }).catch(function(err) {
                dispatch(modalUpdate({
                    pageWarn: err.message,
                    loadingTable: false
                }));
            });
    };
}

// å¯¹åº”çš„action Mapper
export function updateApply(data) {
    return {
        type: UPDATE_APPLY,
        data
    };
}
```

è¿™é‡Œæ˜¯åšå®¢æ–‡ç« çš„ä»£ç é£æ ¼å†™æ³•
```javascript
const fetchPosts = postTitle => (dispatch, getState) => {
  dispatch(requestPosts(postTitle));
  return fetch(`/some/API/${postTitle}.json`)
    .then(response => response.json())
    .then(json => dispatch(receivePosts(postTitle, json)));
};

// ä½¿ç”¨æ–¹æ³•ä¸€
store.dispatch(fetchPosts('reactjs'));
// ä½¿ç”¨æ–¹æ³•äºŒ
store.dispatch(fetchPosts('reactjs')).then(() =>
  console.log(store.getState())
);
```
ä¸Šé¢ä»£ç ä¸­ï¼ŒfetchPostsæ˜¯ä¸€ä¸ªAction Creatorï¼ˆåŠ¨ä½œç”Ÿæˆå™¨ï¼‰ï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ã€‚
è¿™ä¸ªå‡½æ•°æ‰§è¡Œåï¼Œå…ˆå‘å‡ºä¸€ä¸ªActionï¼ˆrequestPosts(postTitle)ï¼‰ï¼Œç„¶åè¿›è¡Œå¼‚æ­¥æ“ä½œã€‚
æ‹¿åˆ°ç»“æœåï¼Œå…ˆå°†ç»“æœè½¬æˆ JSON æ ¼å¼ï¼Œç„¶åå†å‘å‡ºä¸€ä¸ª Actionï¼ˆ receivePosts(postTitle, json)ï¼‰ã€‚                                    

ä¸Šé¢ä»£ç ä¸­ï¼Œæœ‰å‡ ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ã€‚
- ï¼ˆ1ï¼‰fetchPostsè¿”å›äº†ä¸€ä¸ªå‡½æ•°ï¼Œè€Œæ™®é€šçš„ Action Creator é»˜è®¤è¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚
- ï¼ˆ2ï¼‰è¿”å›çš„å‡½æ•°çš„å‚æ•°æ˜¯dispatchå’ŒgetStateè¿™ä¸¤ä¸ª Redux æ–¹æ³•ï¼Œæ™®é€šçš„ Action Creator çš„å‚æ•°æ˜¯ Action çš„å†…å®¹ã€‚
- ï¼ˆ3ï¼‰åœ¨è¿”å›çš„å‡½æ•°ä¹‹ä¸­ï¼Œå…ˆå‘å‡ºä¸€ä¸ª Actionï¼ˆrequestPosts(postTitle)ï¼‰ï¼Œè¡¨ç¤ºæ“ä½œå¼€å§‹ã€‚
- ï¼ˆ4ï¼‰å¼‚æ­¥æ“ä½œç»“æŸä¹‹åï¼Œå†å‘å‡ºä¸€ä¸ª Actionï¼ˆreceivePosts(postTitle, json)ï¼‰ï¼Œè¡¨ç¤ºæ“ä½œç»“æŸã€‚

è¿™æ ·çš„å¤„ç†ï¼Œå°±è§£å†³äº†è‡ªåŠ¨å‘é€ç¬¬äºŒä¸ª Action çš„é—®é¢˜ã€‚ä½†æ˜¯ï¼Œåˆå¸¦æ¥äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼ŒAction æ˜¯ç”±store.dispatchæ–¹æ³•å‘é€çš„ã€‚
è€Œstore.dispatchæ–¹æ³•æ­£å¸¸æƒ…å†µä¸‹ï¼Œå‚æ•°åªèƒ½æ˜¯å¯¹è±¡ï¼Œä¸èƒ½æ˜¯å‡½æ•°ã€‚                               
è¿™æ—¶ï¼Œå°±è¦ä½¿ç”¨ä¸­é—´ä»¶**redux-thunk**ã€‚
```javascript
import { createStore, applyMiddleware } from 'redux';
import thunk from 'redux-thunk';
import reducer from './reducers';

// Note: this API requires redux@>=3.1.0
const store = createStore(
  reducer,
  applyMiddleware(thunk)
);
```
ä¸Šé¢ä»£ç ä½¿ç”¨redux-thunkä¸­é—´ä»¶ï¼Œæ”¹é€ store.dispatchï¼Œä½¿å¾—åè€…å¯ä»¥æ¥å—å‡½æ•°ä½œä¸ºå‚æ•°ã€‚                       
å› æ­¤ï¼Œå¼‚æ­¥æ“ä½œçš„ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼Œå†™å‡ºä¸€ä¸ªè¿”å›å‡½æ•°çš„ Action Creatorï¼Œç„¶åä½¿ç”¨redux-thunkä¸­é—´ä»¶æ”¹é€ store.dispatchã€‚


## <div id="05">5ã€React-Reduxçš„ç”¨æ³•</div>
ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼ŒRedux çš„ä½œè€…å°è£…äº†ä¸€ä¸ª React ä¸“ç”¨çš„åº“ React-Reduxï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»å®ƒã€‚                       
è¿™ä¸ªåº“æ˜¯å¯ä»¥é€‰ç”¨çš„ã€‚å®é™…é¡¹ç›®ä¸­ï¼Œä½ åº”è¯¥æƒè¡¡ä¸€ä¸‹ï¼Œæ˜¯ç›´æ¥ä½¿ç”¨ Reduxï¼Œè¿˜æ˜¯ä½¿ç”¨ React-Reduxã€‚åè€…è™½ç„¶æä¾›äº†ä¾¿åˆ©ï¼Œä½†æ˜¯éœ€è¦æŒæ¡é¢å¤–çš„ APIï¼Œå¹¶ä¸”è¦éµå®ˆå®ƒçš„ç»„ä»¶æ‹†åˆ†è§„èŒƒã€‚

æœ¬äººé¡¹ç›®ä¸­ä½¿ç”¨çš„æœ€å¤šçš„å°±æ˜¯ react-redux;                      

React-Redux å°†æ‰€æœ‰ç»„ä»¶åˆ†æˆä¸¤å¤§ç±»ï¼š**UI ç»„ä»¶ï¼ˆpresentational componentï¼‰å’Œå®¹å™¨ç»„ä»¶ï¼ˆcontainer componentï¼‰**ã€‚

### UIç»„ä»¶
UI ç»„ä»¶æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹å¾ã€‚                           
- åªè´Ÿè´£ UI çš„å‘ˆç°ï¼Œä¸å¸¦æœ‰ä»»ä½•ä¸šåŠ¡é€»è¾‘
- æ²¡æœ‰çŠ¶æ€ï¼ˆå³ä¸ä½¿ç”¨this.stateè¿™ä¸ªå˜é‡ï¼‰
- æ‰€æœ‰æ•°æ®éƒ½ç”±å‚æ•°ï¼ˆthis.propsï¼‰æä¾›
- ä¸ä½¿ç”¨ä»»ä½• Redux çš„ API

ä¸‹é¢å°±æ˜¯ä¸€ä¸ª UI ç»„ä»¶çš„ä¾‹å­ã€‚
```javascript
const Title = value => <h1>{value}</h1>;
```
å› ä¸ºä¸å«æœ‰çŠ¶æ€ï¼ŒUI ç»„ä»¶åˆç§°ä¸º"çº¯ç»„ä»¶"ï¼Œå³å®ƒçº¯å‡½æ•°ä¸€æ ·ï¼Œçº¯ç²¹ç”±å‚æ•°å†³å®šå®ƒçš„å€¼ã€‚

### å®¹å™¨ç»„ä»¶
å®¹å™¨ç»„ä»¶çš„ç‰¹å¾æ°æ°ç›¸åã€‚
- è´Ÿè´£ç®¡ç†æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼Œä¸è´Ÿè´£ UI çš„å‘ˆç°
- å¸¦æœ‰å†…éƒ¨çŠ¶æ€
- ä½¿ç”¨ Redux çš„ API

æ€»ä¹‹ï¼Œåªè¦è®°ä½ä¸€å¥è¯å°±å¯ä»¥äº†ï¼šUI ç»„ä»¶è´Ÿè´£ UI çš„å‘ˆç°ï¼Œå®¹å™¨ç»„ä»¶è´Ÿè´£ç®¡ç†æ•°æ®å’Œé€»è¾‘ã€‚

ä½ å¯èƒ½ä¼šé—®ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶æ—¢æœ‰ UI åˆæœ‰ä¸šåŠ¡é€»è¾‘ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿå›ç­”æ˜¯ï¼Œå°†å®ƒæ‹†åˆ†æˆä¸‹é¢çš„ç»“æ„ï¼šå¤–é¢æ˜¯ä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œé‡Œé¢åŒ…äº†ä¸€ä¸ªUI ç»„ä»¶ã€‚å‰è€…è´Ÿè´£ä¸å¤–éƒ¨çš„é€šä¿¡ï¼Œå°†æ•°æ®ä¼ ç»™åè€…ï¼Œç”±åè€…æ¸²æŸ“å‡ºè§†å›¾ã€‚                         
React-Redux è§„å®šï¼Œæ‰€æœ‰çš„ UI ç»„ä»¶éƒ½ç”±ç”¨æˆ·æä¾›ï¼Œå®¹å™¨ç»„ä»¶åˆ™æ˜¯ç”± React-Redux è‡ªåŠ¨ç”Ÿæˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·è´Ÿè´£è§†è§‰å±‚ï¼ŒçŠ¶æ€ç®¡ç†åˆ™æ˜¯å…¨éƒ¨äº¤ç»™å®ƒã€‚

### connect()
React-Redux æä¾›connectæ–¹æ³•ï¼Œç”¨äºä» UI ç»„ä»¶ç”Ÿæˆå®¹å™¨ç»„ä»¶ã€‚connectçš„æ„æ€ï¼Œå°±æ˜¯å°†è¿™ä¸¤ç§ç»„ä»¶è¿èµ·æ¥ã€‚                         
connectæ–¹æ³•çš„å®Œæ•´ API å¦‚ä¸‹ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­æ˜¯æˆ‘åœ¨é¡¹ç›®ä¸­ä½¿ç”¨çš„ä¸€ä¸ªå®Œæ•´ç»“æ„ç¤ºä¾‹                    
```javascript
/* eslint-disable react/jsx-no-target-blank */
import React, {Component} from 'react';
import {push} from 'react-router-redux';
import {connect} from 'react-redux';
import PropTypes from 'prop-types';
import {Button, message} from 'antd';

// mapStateToProps
function propMap(state, ownProps) {
    return {
        modal: state.modal,
        routing: ownProps
    };
}

class InvoiceList extends Component {
    constructor() {
        super();
        this.state = {
            invoiceListData: {}
        };
        this.handleGetList = this.handleGetList.bind(this);
    }

    componentDidMount() {
        // æ¯æ¬¡åˆ·æ–°ç©ºæ‹‰æ•°æ®ä¸€æ¬¡
        this.handleGetList();
    }

    render() {
        const {routing, modal} = this.props;
        return (
            <div className="app-reimbursement-invoice-list">
                <ReimbursementHeaderNav current="invoice-list"/>
                {/*.......*/}
            </div>
        );
    }

    // ç‚¹å‡»æŸ¥è¯¢æ•°æ®
    handleGetList(filters, type) {
        console.log('ç‚¹å‡»æŸ¥è¯¢æ•°æ®')
    }
}
InvoiceList.propTypes = {
    routing: PropTypes.object.isRequired,
    modal: PropTypes.object.isRequired,
    dispatch: PropTypes.func.isRequired
};
export default connect(propMap)(InvoiceList);
```
InvoiceListå°±æ˜¯ç”± React-Redux é€šè¿‡connectæ–¹æ³•è‡ªåŠ¨ç”Ÿæˆçš„å®¹å™¨ç»„ä»¶ã€‚
connectæ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šmapStateToPropså’ŒmapDispatchToPropsã€‚
å®ƒä»¬å®šä¹‰äº† UI ç»„ä»¶çš„ä¸šåŠ¡é€»è¾‘ã€‚å‰è€…è´Ÿè´£è¾“å…¥é€»è¾‘ï¼Œå³å°†stateæ˜ å°„åˆ° UI ç»„ä»¶çš„å‚æ•°ï¼ˆpropsï¼‰ï¼Œåè€…è´Ÿè´£è¾“å‡ºé€»è¾‘ï¼Œå³å°†ç”¨æˆ·å¯¹ UI ç»„ä»¶çš„æ“ä½œæ˜ å°„æˆ Actionã€‚
é€šå¸¸æˆ‘ä»¬åªä½¿ç”¨äº†ç¬¬ä¸€ä¸ªå‚æ•°ï¼›                      

### mapStateToProps                         
mapStateToPropsæ˜¯ä¸€ä¸ªå‡½æ•°ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯åƒå®ƒçš„åå­—é‚£æ ·ï¼Œå»ºç«‹ä¸€ä¸ªä»ï¼ˆå¤–éƒ¨çš„ï¼‰stateå¯¹è±¡åˆ°ï¼ˆUI ç»„ä»¶çš„ï¼‰propså¯¹è±¡çš„æ˜ å°„å…³ç³»ã€‚
ä½œä¸ºå‡½æ•°ï¼ŒmapStateToPropsæ‰§è¡Œååº”è¯¥è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹å°±æ˜¯ä¸€ä¸ªæ˜ å°„ã€‚                    
```javascript
const mapStateToProps = (state) => {
  return {
    todos: getVisibleTodos(state.todos, state.visibilityFilter)
  }
}
```
ä¸Šé¢ä»£ç ä¸­ï¼ŒmapStateToPropsæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—stateä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªtodoså±æ€§ï¼Œä»£è¡¨ UI ç»„ä»¶çš„åŒåå‚æ•°ï¼Œ
åé¢çš„getVisibleTodosä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥ä»stateç®—å‡º todos çš„å€¼ã€‚                       
ä¸‹é¢å°±æ˜¯getVisibleTodosçš„ä¸€ä¸ªä¾‹å­ï¼Œç”¨æ¥ç®—å‡ºtodosã€‚                     
```javascript
const getVisibleTodos = (todos, filter) => {
  switch (filter) {
    case 'SHOW_ALL':
      return todos
    case 'SHOW_COMPLETED':
      return todos.filter(t => t.completed)
    case 'SHOW_ACTIVE':
      return todos.filter(t => !t.completed)
    default:
      throw new Error('Unknown filter: ' + filter)
  }
}
```
mapStateToPropsä¼šè®¢é˜… Storeï¼Œæ¯å½“stateæ›´æ–°çš„æ—¶å€™ï¼Œå°±ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œé‡æ–°è®¡ç®— UI ç»„ä»¶çš„å‚æ•°ï¼Œä»è€Œè§¦å‘ UI ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚                     
mapStateToPropsçš„ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯stateå¯¹è±¡ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•°ï¼Œä»£è¡¨å®¹å™¨ç»„ä»¶çš„propså¯¹è±¡                            
```javascript
const mapStateToProps = (state, ownProps) => {
  return {
    active: ownProps.filter === state.visibilityFilter
  }
}
```
ä½¿ç”¨ownPropsä½œä¸ºå‚æ•°åï¼Œå¦‚æœå®¹å™¨ç»„ä»¶çš„å‚æ•°å‘ç”Ÿå˜åŒ–ï¼Œä¹Ÿä¼šå¼•å‘ UI ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚                   
connectæ–¹æ³•å¯ä»¥çœç•¥mapStateToPropså‚æ•°ï¼Œé‚£æ ·çš„è¯ï¼ŒUI ç»„ä»¶å°±ä¸ä¼šè®¢é˜…Storeï¼Œå°±æ˜¯è¯´ Store çš„æ›´æ–°ä¸ä¼šå¼•èµ· UI ç»„ä»¶çš„æ›´æ–°ã€‚                     


### mapDispatchToProps()
mapDispatchToPropsæ˜¯connectå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ¥å»ºç«‹ UI ç»„ä»¶çš„å‚æ•°åˆ°store.dispatchæ–¹æ³•çš„æ˜ å°„ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå®šä¹‰äº†å“ªäº›ç”¨æˆ·çš„æ“ä½œåº”è¯¥å½“ä½œ Actionï¼Œä¼ ç»™ Storeã€‚å®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚

å¦‚æœmapDispatchToPropsæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼šå¾—åˆ°dispatchå’ŒownPropsï¼ˆå®¹å™¨ç»„ä»¶çš„propså¯¹è±¡ï¼‰ä¸¤ä¸ªå‚æ•°ã€‚
```javascript
const mapDispatchToProps = (
  dispatch,
  ownProps
) => {
  return {
    onClick: () => {
      dispatch({
        type: 'SET_VISIBILITY_FILTER',
        filter: ownProps.filter
      });
    }
  };
}
```
ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒmapDispatchToPropsä½œä¸ºå‡½æ•°ï¼Œåº”è¯¥è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„æ¯ä¸ªé”®å€¼å¯¹éƒ½æ˜¯ä¸€ä¸ªæ˜ å°„ï¼Œå®šä¹‰äº† UI ç»„ä»¶çš„å‚æ•°æ€æ ·å‘å‡º Actionã€‚                  

å¦‚æœmapDispatchToPropsæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„æ¯ä¸ªé”®åä¹Ÿæ˜¯å¯¹åº” UI ç»„ä»¶çš„åŒåå‚æ•°ï¼Œé”®å€¼åº”è¯¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼šè¢«å½“ä½œ Action creator ï¼Œ
è¿”å›çš„ Action ä¼šç”± Redux è‡ªåŠ¨å‘å‡ºã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œä¸Šé¢çš„mapDispatchToPropså†™æˆå¯¹è±¡å°±æ˜¯ä¸‹é¢è¿™æ ·ã€‚                                  
```ecmascript 6
const mapDispatchToProps = {
  onClick: (filter) => {
    type: 'SET_VISIBILITY_FILTER',
    filter: filter
  }
}
```

æ€»ç»“ï¼Œå®é™…ä¸Šé¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œ åªç”¨å¾—ä¸Šç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸€èˆ¬æ¥è¯´æ˜¯å°è£…åœ¨reducers å±‚æ¬¡é‡Œé¢çš„ã€‚ä¸å»ºè®®ç›´æ¥æ”¾ç½®åœ¨ç»„å»ºæˆæ­¤è°ƒç”¨ã€‚å› ä¸ºä¼šå¯¼è‡´ä½¿ç”¨å’Œæ•°æ®ä¸Šçš„ç´Šä¹±ã€‚                     


### <Provider>ç»„ä»¶
connectæ–¹æ³•ç”Ÿæˆå®¹å™¨ç»„ä»¶ä»¥åï¼Œéœ€è¦è®©å®¹å™¨ç»„ä»¶æ‹¿åˆ°stateå¯¹è±¡ï¼Œæ‰èƒ½ç”Ÿæˆ UI ç»„ä»¶çš„å‚æ•°ã€‚React-Redux æä¾›Providerç»„ä»¶ï¼Œå¯ä»¥è®©å®¹å™¨ç»„ä»¶æ‹¿åˆ°stateã€‚
```javascript
import { Provider } from 'react-redux'
import { createStore } from 'redux'
import todoApp from './reducers'
import App from './components/App'

let store = createStore(todoApp);

render(
  <Provider store={store}>
    <App />
  </Provider>,
  document.getElementById('root')
)
```
ä¸Šé¢ä»£ç ä¸­ï¼ŒProvideråœ¨æ ¹ç»„ä»¶å¤–é¢åŒ…äº†ä¸€å±‚ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒAppçš„æ‰€æœ‰å­ç»„ä»¶å°±é»˜è®¤éƒ½å¯ä»¥æ‹¿åˆ°stateäº†ã€‚

### React-Routerè·¯ç”±åº“
ä½¿ç”¨React-Routerçš„é¡¹ç›®ï¼Œä¸å…¶ä»–é¡¹ç›®æ²¡æœ‰ä¸åŒä¹‹å¤„ï¼Œä¹Ÿæ˜¯ä½¿ç”¨Provideråœ¨Routerå¤–é¢åŒ…ä¸€å±‚ï¼Œæ¯•ç«ŸProviderçš„å”¯ä¸€åŠŸèƒ½å°±æ˜¯ä¼ å…¥storeå¯¹è±¡ã€‚
```javascript
const Root = ({ store }) => (
  <Provider store={store}>
    <Router>
      <Route path="/" component={App} />
    </Router>
  </Provider>
);
```




           

